# ==========================================
# Stage 1: Dependencies
# ==========================================
# ビルドに必要な全ての依存関係をインストールするステージ
FROM node:20-slim AS deps
WORKDIR /app

# Prismaの実行に必要なOpenSSLライブラリをインストール
RUN apt-get update -y && \
    apt-get install -y openssl && \
    rm -rf /var/lib/apt/lists/*

# package.jsonとpackage-lock.jsonをコピー
COPY package*.json ./

# .npmrcの認証情報を安全に渡し、依存関係をインストール (--omit=devを付けずに全て)
RUN --mount=type=secret,id=npmrc,target=/root/.npmrc npm ci

# ==========================================
# Stage 2: Builder
# ==========================================
# アプリケーションをビルドするステージ
FROM node:20-slim AS builder
WORKDIR /app

# Stage 1 から依存関係をコピー
COPY --from=deps /app/node_modules ./node_modules

# PrismaスキーマのみをコピーしてDockerレイヤーキャッシュを最大活用
# → アプリコードのみ変更時に prisma generate がキャッシュヒットする
COPY prisma ./prisma

# Prisma Client を生成（スキーマが変わらない限りキャッシュが有効）
RUN npx prisma generate

# アプリケーションコードをコピー（コード変更時も上記レイヤーはキャッシュ済み）
COPY . .

# 生成されたPrisma ClientをsrcディレクトリへMOVE
RUN rm -rf src/generated && mv generated src/

# package.jsonの "build" スクリプトを実行 (TypeScript -> JavaScript)
RUN npm run build

# ==========================================
# Stage 3: Runner (本番環境)
# ==========================================
# 実際にバッチ処理を実行する本番用ステージ
FROM node:20-slim AS runner
WORKDIR /app

# Prismaの実行に必要なOpenSSLライブラリをインストール
RUN apt-get update -y && \
    apt-get install -y openssl && \
    rm -rf /var/lib/apt/lists/*

ENV NODE_ENV=production

# セキュリティのため、専用の非rootユーザー(batchuser)を作成
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 batchuser

# package.jsonとpackage-lock.jsonをコピー
COPY package*.json ./

# .npmrcの認証情報を安全に渡し、本番用の依存関係のみをインストール
RUN --mount=type=secret,id=npmrc,target=/root/.npmrc npm ci --omit=dev

# Builderステージからコンパイル済みのコード(/dist)をコピー
COPY --from=builder --chown=batchuser:nodejs /app/dist ./dist

# Builderステージから生成されたPrisma Clientをコピー (実行時に必須)
COPY --from=builder --chown=batchuser:nodejs /app/node_modules/.prisma ./node_modules/.prisma

# BuilderステージからPrismaスキーマファイルをコピー (実行時参照される可能性を考慮)
COPY --from=builder --chown=batchuser:nodejs /app/prisma ./prisma

# ユーザーをbatchuserに切り替え
USER batchuser

# ENTRYPOINTとしてnodeを指定。実行するスクリプトはコンテナ起動時の引数で指定。
ENTRYPOINT ["node"]
