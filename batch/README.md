# TestCaseDB Batch Jobs

このディレクトリには、TestCaseDBのバッチ処理が含まれています。

## セットアップ

### 1. 依存パッケージのインストール

```bash
npm install
```

### 2. 環境変数の設定

`.env.example` をコピーして `.env` ファイルを作成し、必要な環境変数を設定してください。

```bash
cp .env.example .env
```

### 3. Prisma Clientの生成

```bash
npm run prisma:generate
```

## バッチ一覧

### ユーザーインポートバッチ

CSVファイルからユーザー情報を一括登録・更新します。

#### 実行方法

```bash
npm run user-import
```

#### 必要な環境変数

- `DATABASE_URL`: データベース接続URL
- `STORAGE_MODE`: ストレージモード（`s3` または `local`、デフォルト: `s3`）
- `EXECUTOR_NAME`: 実行者名（省略可、デフォルト: `system`）
- `AWS_REGION`: AWSリージョン（省略可、デフォルト: `ap-northeast-1`）

**S3モード**の場合：
- `INPUT_S3_BUCKET`: 入力CSVファイルが格納されているS3バケット名
- `INPUT_S3_KEY`: 入力CSVファイルのS3キー（例: `user-import/users.csv`）
- `OUTPUT_S3_BUCKET`: 実行結果を出力するS3バケット名

**ローカルモード**の場合：
- `INPUT_FILE_PATH`: 入力CSVファイルのパス（例: `/path/to/users.csv`）
- `OUTPUT_DIR_PATH`: 実行結果を出力するディレクトリパス（例: `/path/to/output`）

#### CSVフォーマット

| 項目名 | 必須 | 説明 |
|--------|------|------|
| ID | - | 既存ユーザーのID（更新時のみ） |
| ID(メールアドレス) | ○ | メールアドレス |
| 氏名 | ○ | ユーザー名 |
| パスワード | ○※ | パスワード（新規作成時は必須） |
| 部署 | - | 部署名 |
| 会社名 | - | 会社名 |
| 権限 | ○ | 0: システム管理者, 1: テスト管理者, 2: 一般 |
| タグ | - | タグ（セミコロン区切り） |
| ステータス | - | 0: 有効, 1: 無効 |

---

### テストケースインポートバッチ

ZIPファイル（CSV + 添付ファイル）からテストケース情報を一括登録します。

#### 実行方法

```bash
npm run test-case-import
```

#### 必要な環境変数

- `DATABASE_URL`: データベース接続URL
- `INPUT_S3_BUCKET`: 入力ZIPファイルが格納されているS3バケット名
- `INPUT_S3_KEY`: 入力ZIPファイルのS3キー（例: `test-case-import/test-cases.zip`）
- `OUTPUT_S3_BUCKET`: 実行結果を出力するS3バケット名
- `TEST_GROUP_ID`: インポート先のテストグループID
- `FILE_S3_BUCKET`: ファイルをアップロードするS3バケット名（S3モード時）
- `STORAGE_MODE`: ストレージモード（`s3` または `local`、デフォルト: `s3`）
- `LOCAL_UPLOAD_BASE_PATH`: ローカルストレージのベースパス（ローカルモード時）
- `EXECUTOR_NAME`: 実行者名（省略可、デフォルト: `system`）
- `AWS_REGION`: AWSリージョン（省略可、デフォルト: `ap-northeast-1`）

#### ZIPファイル構造

ZIPファイルには以下のファイルを同一階層に格納します：

```
test-cases.zip
├── test-cases.csv          # テストケース定義CSV（1ファイルのみ）
├── 制御仕様_1_1_1_1.html   # 制御仕様ファイル（複数可）
├── データフロー_1_1_1_1.html # データフローファイル（複数可）
├── エビデンス_1_1_1_1_1.png # エビデンスファイル（複数可）
└── ...
```

#### CSVフォーマット

| No. | 項目名 | 必須 | 最大桁数 | 書式 | 備考 |
|-----|--------|------|----------|------|------|
| 1 | TID | ○ | 255 | 半角ハイフンつながりの半角数字 | 例: `1-1-1-1` |
| 2 | No | ○ | 255 | 半角数字 | テストケース番号 |
| 3 | 第1層 | ○ | 255 | 文字列 | |
| 4 | 第2層 | ○ | 255 | 文字列 | |
| 5 | 第3層 | ○ | 255 | 文字列 | |
| 6 | 第4層 | ○ | 255 | 文字列 | |
| 7 | 目的 | ○ | 255 | 文字列 | |
| 8 | 要求ID | ○ | 255 | 文字列 | |
| 9 | 確認観点 | ○ | - | 文字列 | |
| 10 | 制御仕様 | ○ | - | ファイルパス | セミコロン区切りで複数指定可。例: `./制御仕様_1.html;./制御仕様_2.html` |
| 11 | データフロー | ○ | - | ファイルパス | セミコロン区切りで複数指定可。例: `./データフロー_1.html;./データフロー_2.html` |
| 12 | テスト手順 | ○ | - | 文字列 | |
| 13 | テストケース | ○ | - | 文字列 | |
| 14 | 期待値 | ○ | - | 文字列 | |
| 15 | 結果 | ○ | - | 文字列 | |
| 16 | 判定 | ○ | - | 文字列 | 未着手、保留、QA中、OK、参照OK、NG、再実施対象外、対象外のいずれか |
| 17 | 実施日 | ○ | - | 日付 | yyyy/mm/dd形式。例: `2025/01/01` |
| 18 | ソフトVer. | ○ | 255 | 文字列 | |
| 19 | ハードVer. | ○ | 255 | 文字列 | |
| 20 | コンパラVer. | ○ | 255 | 文字列 | |
| 21 | 実施者 | ○ | 255 | 文字列 | |
| 22 | エビデンス | - | - | ファイルパス | セミコロン区切りで複数指定可。例: `./エビデンス_1.png;./エビデンス_2.png` |
| 23 | 備考 | ○ | - | 文字列 | |

#### 注意事項

1. **同一TIDの扱い**: 同じTIDで複数行がある場合、それらは1つのテストケースの複数のテスト内容（No）として扱われます。
2. **TID重複エラー**: 既に登録されているTIDがある場合、エラーとなり全件ロールバックされます。
3. **トランザクション**: 全てのテストケースが1つのトランザクション内で処理されるため、1件でもエラーがあれば全件ロールバックされます。
4. **ファイルパス**: CSV内のファイルパスはZIPファイル内の相対パスで指定します（先頭に `./` をつける）。
5. **対象外判定**: 判定が「対象外」の場合、`is_target = false` として登録されます。
6. **履歴カウント**: インポート時の履歴カウントは常に `1` です。
7. **ストレージモード**:
   - `s3`: ファイルはS3にアップロードされます
   - `local`: ファイルはローカルの `public` ディレクトリに保存されます

## ビルド

TypeScriptをコンパイルしてJavaScriptを生成します。

```bash
npm run build
```

コンパイルされたファイルは `dist/` ディレクトリに出力されます。

## トラブルシューティング

### エラー: `必須の環境変数が設定されていません`

`.env` ファイルに必要な環境変数が設定されているか確認してください。

### エラー: `CSVのパースに失敗しました`

- CSVファイルの文字コードがUTF-8であることを確認してください。
- CSVファイルの形式が正しいか確認してください（ヘッダー行が存在するか、列数が正しいか）。

### エラー: `ZIPファイル内にCSVファイルが複数含まれています`

ZIPファイル内のCSVファイルは1つだけにしてください。

### エラー: `ファイル "xxx" がZIP内に見つかりません`

CSV内で参照しているファイルパスが正しいか、またそのファイルがZIPに含まれているか確認してください。

### エラー: `TID「xxx」は既に登録されています`

既に登録されているTIDを含むCSVはインポートできません。重複しないTIDを使用するか、既存のテストケースを削除してから再実行してください。

### トランザクションタイムアウト

大量のテストケースをインポートする場合、トランザクションタイムアウトが発生する可能性があります。その場合は、データを分割して複数回に分けてインポートしてください。

## ログ

バッチ実行中のログはコンソールに出力されます。また、実行結果は以下の形式で保存されます：

**S3モード**の場合：
- ユーザーインポート結果:
  - JSON形式: `{OUTPUT_S3_BUCKET}/user-import-results/result-{timestamp}.json`
  - CSV形式: `{OUTPUT_S3_BUCKET}/user-import-results/result-{timestamp}.csv`
- テストケースインポート結果:
  - JSON形式: `{OUTPUT_S3_BUCKET}/test-case-import-results/result-{timestamp}.json`
  - CSV形式: `{OUTPUT_S3_BUCKET}/test-case-import-results/result-{timestamp}.csv`

**ローカルモード**の場合：
- ユーザーインポート結果:
  - JSON形式: `{OUTPUT_DIR_PATH}/result-{timestamp}.json`
  - CSV形式: `{OUTPUT_DIR_PATH}/result-{timestamp}.csv`
- テストケースインポート結果:
  - JSON形式: `{OUTPUT_DIR_PATH}/result-{timestamp}.json`
  - CSV形式: `{OUTPUT_DIR_PATH}/result-{timestamp}.csv`

実行状態は `tt_import_results` テーブルに記録されます：

- `import_status = 0`: 実施中
- `import_status = 1`: 成功
- `import_status = 2`: エラー

## ライセンス

このプロジェクトは社内利用専用です。
