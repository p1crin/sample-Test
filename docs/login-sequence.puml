@startuml Login Flow
title ログイン画面のシーケンス図（最新版）
skinparam sequenceParticipant underline

actor "ユーザー" as user
participant "ブラウザ" as browser
participant "ログイン画面\n(Next.js Client)" as login_screen
participant "NextAuth\ncredentials provider" as nextauth
participant "API Route\n/api/auth/[...nextauth]" as auth_api
database "AWS RDS\n(PostgreSQL)" as db

user ->> browser: メールアドレス・パスワードを入力
activate browser
note over browser: {email, password}

browser ->> login_screen: フォーム送受信
activate login_screen

note over login_screen: クライアント側バリデーション\n(Zod schema)\n- 空値チェック\n- メール形式チェック

alt バリデーション失敗
  login_screen -->> browser: エラーメッセージ表示\n(赤文字)
  deactivate login_screen
else バリデーション成功
  login_screen ->> nextauth: signIn('credentials',\n{email, password,\nredirect: false})
  activate nextauth

  note over nextauth: NextAuth.js\ncredentials provider処理

  nextauth ->> auth_api: POST /api/auth/callback/credentials
  activate auth_api

  note over auth_api: サーバー側バリデーション\n& 認証処理

  auth_api ->> db: ユーザー取得クエリ実行
  note over db: SELECT id, email, password, user_role\nFROM mt_users\nWHERE email = $1\nAND is_deleted = FALSE

  activate db
  db -->> auth_api: ユーザーレコード
  deactivate db

  alt ユーザーが存在しない
    auth_api -->> nextauth: null (認証失敗)
    deactivate auth_api
    nextauth -->> login_screen: {error: "Invalid credentials"}
    deactivate nextauth

    login_screen -->> browser: エラーメッセージ表示\n「メールアドレスまたはパスワードが\n正しくありません」
    deactivate login_screen

  else ユーザーが存在
    note over auth_api: bcrypt.compare(\n入力PW, 保存PW)\n パスワード検証

    alt パスワード不一致
      auth_api -->> nextauth: null (認証失敗)
      deactivate auth_api
      nextauth -->> login_screen: {error: "Invalid credentials"}
      deactivate nextauth

      login_screen -->> browser: エラーメッセージ表示
      deactivate login_screen

    else パスワード一致
      note over auth_api: ユーザー情報を返却\n{id, email, name, user_role}

      auth_api -->> nextauth: ユーザー認証情報
      deactivate auth_api

      note over nextauth: NextAuth セッション生成\n- JWT署名\n- Cookie設定\n(next-auth.session-token)

      nextauth -->> login_screen: {ok: true, status: 200}
      deactivate nextauth

      note over login_screen: useSession()フック\nでセッション取得確認

      login_screen ->> login_screen: Redux store更新\n(loginAction dispatch)

      note over login_screen: custom token生成\n& sessionStorage保存

      login_screen -->> user: ダッシュボードへリダイレクト\n(/testGroup)
      deactivate login_screen
    end
  end
end

deactivate browser

note over user: セッション状態\n- Cookie: next-auth.session-token\n- Redux: auth state\n- sessionStorage: custom token
@enduml
