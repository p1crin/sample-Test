@startuml Test Group List Flow
title テストグループ一覧画面のシーケンス図（最新版）
skinparam sequenceParticipant underline

actor "ユーザー" as user
participant "ブラウザ" as browser
participant "テストグループ一覧画面\n(Next.js Client)" as list_screen
participant "API Route\n/api/test-groups" as api
database "AWS RDS\n(PostgreSQL)" as db

user ->> browser: テストグループ一覧ページをロード
activate browser
browser ->> list_screen: ページアクセス
activate list_screen

note over list_screen: 認証確認\n- useSession()で確認\n- セッションvalid性チェック

alt セッション無効
  list_screen -->> user: ログイン画面へリダイレクト
  deactivate list_screen
else セッション有効
  note over list_screen: URL パラメータ読み込み\n- 検索条件\n- ページ番号

  list_screen ->> api: GET /api/test-groups?page=1&limit=10\n&oem=...&model=...
  activate api

  note over api: 認証確認\n- requireAuth()で\nセッション検証\n- ユーザー情報抽出

  alt 認証失敗
    api -->> list_screen: {error: '認証が必要です'}\n(401)
    deactivate api
    list_screen -->> user: ログイン画面へリダイレクト
    deactivate list_screen

  else 認証成功
    api ->> api: 権限チェック\n- getAccessibleTestGroups()\n  ユーザーアクセス可能なID一覧取得

    note over api: 権限別フィルター\n- Admin: 全グループ\n- TestManager: 自作 or 割当\n- General: 割当のみ

    alt アクセス可能グループがない
      api -->> list_screen: {success: true, data: [],\ntotalCount: 0}
      deactivate api

      list_screen -->> browser: 「グループがありません」表示
      deactivate list_screen

    else アクセス可能グループあり
      api ->> db: 合計件数取得クエリ
      note over db: SELECT COUNT(*) as count\nFROM tt_test_groups\nWHERE id = ANY(accessibleIds)\nAND is_deleted = FALSE\nAND oem ILIKE ...\nAND model ILIKE ...

      activate db
      db -->> api: count: 18件
      deactivate db

      note over api: ページネーション計算\n- totalCount: 18\n- pageCount: ceil(18/10) = 2ページ

      api ->> db: ページング付きデータ取得
      note over db: SELECT id, oem, model, event,\nvariation, destination, ...\nFROM tt_test_groups\nWHERE ...\nORDER BY created_at DESC\nLIMIT 10 OFFSET 0

      activate db
      db -->> api: テストグループ10件
      deactivate db

      api -->> list_screen: {success: true,\ndata: [...],\ntotalCount: 18}
      deactivate api

      note over list_screen: レスポンス処理\n- データ配列をstate設定\n- ページ情報更新

      list_screen -->> browser: テストグループ一覧表示\n+ ページネーション\n(ページ1 / 2)
      deactivate list_screen
    end
  end

  browser -->> user: 一覧画面を表示\n(10件 + ページボタン)
end

note over user: IDクリック時の動作

user ->> browser: テストグループID「123」をクリック
activate browser

browser ->> list_screen: IDクリックイベント\n(render関数実行)
activate list_screen

note over list_screen: カスタム render関数処理\n(クエリパラメータ無視)\nLink href={`/testGroup/123/testCase`}

list_screen -->> browser: /testGroup/123/testCase\nへのナビゲーション
deactivate list_screen

note over browser: クエリパラメータは\nクリアされる\nURLが綺麗になる

browser -->> user: テストケース一覧ページ遷移\n(URL: /testGroup/123/testCase)
deactivate browser

note over user: ページ2ボタンクリック時

user ->> browser: ページ2ボタンをクリック
activate browser

browser ->> list_screen: ページ変更イベント\n(handlePageChange)
activate list_screen

note over list_screen: updateUrlParams実行\n- 現在の検索条件保持\n- ページ=2に更新\n- URLを更新

list_screen ->> api: GET /api/test-groups?page=2&limit=10\n&oem=...&model=...
activate api

note over api: 認証確認 & 権限チェック\n(再度実施)

api ->> db: OFFSET 10でデータ取得
note over db: ... LIMIT 10 OFFSET 10

activate db
db -->> api: テストグループ8件
deactivate db

api -->> list_screen: {success: true,\ndata: [...],\ntotalCount: 18}
deactivate api

note over list_screen: ページ状態更新\nページ: 2\n取得件数: 8

list_screen -->> browser: テストグループ一覧更新\n(次の8件表示)
deactivate list_screen

browser -->> user: ページ2を表示
deactivate browser

note over user: 権限別表示例\n- Admin: 全テストグループ表示\n- TestManager: 自分が作成したもの\nまたは割り当てられたもの\n- 一般ユーザー: 割り当てられたものたけ
@enduml
