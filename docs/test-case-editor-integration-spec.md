# テストケース編集画面 結合テスト仕様書

## 目次
1. [概要](#概要)
2. [対象機能](#対象機能)
3. [IT1結合テスト（画面）](#it1結合テスト画面)
4. [IT1結合テスト（API）](#it1結合テストapi)
5. [IT2結合テスト](#it2結合テスト)
6. [ログテストについて](#ログテストについて)

---

## 概要

本仕様書は、テストケース編集画面の結合テストを定義する。

### テストレベル定義

| レベル | 名称 | 観点 |
|--------|------|------|
| IT1 | 単体結合テスト | コンポーネント間の結合確認、API単体の動作確認 |
| IT2 | システム結合テスト | エンドツーエンドのシナリオ、複数機能の連携 |

### 対象画面・API

- **画面**: `/testGroup/[groupId]/testCase/[tid]/edit`
- **API**:
  - `GET /api/test-groups/[groupId]/cases/[tid]`
  - `PUT /api/test-groups/[groupId]/cases/[tid]`
  - `DELETE /api/test-groups/[groupId]/cases/[tid]`
  - `POST /api/files/test-info`
  - `DELETE /api/files/test-info`

---

## 対象機能

| 機能ID | 機能名 | 説明 |
|--------|--------|------|
| F-001 | テストケース取得 | 編集対象のテストケース情報をAPIから取得 |
| F-002 | テストケース更新 | 編集内容をAPIに送信し更新 |
| F-003 | テストケース削除 | テストケースをAPIで削除 |
| F-004 | ファイルアップロード | 制御仕様書・データフローファイルのアップロード |
| F-005 | ファイル削除 | アップロード済みファイルの削除 |
| F-006 | テスト内容行管理 | テスト内容の追加・削除・編集 |
| F-007 | バリデーション | 入力値の検証 |
| F-008 | 認証・認可 | ログイン確認、権限チェック |

---

## IT1結合テスト（画面）

### 正常系

#### IT1-UI-001: 初期表示

| No | テスト項目 | 前提条件 | 操作手順 | 期待結果 |
|----|-----------|----------|----------|----------|
| 1 | 画面初期表示 | 編集権限を持つユーザーでログイン済み | テストケース編集画面に遷移 | ローディング表示後、フォームにテストケース情報が表示される |
| 2 | フォーム初期値設定 | テストケースデータが存在する | 画面表示 | 各入力欄にDB値が正しく表示される（第1〜4階層、目的、チェック項目、手順等） |
| 3 | ファイル一覧表示 | 制御仕様書・データフローファイルが登録済み | 画面表示 | アップロード済みファイル一覧が表示される |
| 4 | テスト内容一覧表示 | テスト内容が複数登録済み | 画面表示 | テスト内容が行として全件表示される |

#### IT1-UI-002: フォーム入力

| No | テスト項目 | 前提条件 | 操作手順 | 期待結果 |
|----|-----------|----------|----------|----------|
| 1 | テキスト入力 | フォーム表示済み | 第1階層フィールドに値を入力 | 入力値が反映される |
| 2 | テキストエリア入力 | フォーム表示済み | チェック項目・テスト手順に複数行入力 | 入力値が反映される |
| 3 | テスト内容行追加 | フォーム表示済み | 「行追加」ボタンをクリック | 新しいテスト内容行が追加される |
| 4 | テスト内容行削除 | テスト内容が2行以上存在 | 行の削除ボタンをクリック | 対象行が削除される（1行は残る） |
| 5 | 対象フラグ切替 | テスト内容行が存在 | 対象チェックボックスをクリック | チェック状態が切り替わる |
| 6 | 一括入力機能 | フォーム表示済み | 一括入力ボタンからテキストを貼り付け | テスト内容が複数行に分割して入力される |

#### IT1-UI-003: ファイル操作

| No | テスト項目 | 前提条件 | 操作手順 | 期待結果 |
|----|-----------|----------|----------|----------|
| 1 | ファイル選択 | フォーム表示済み | ファイル選択ダイアログからファイルを選択 | 選択ファイルが一覧に追加される |
| 2 | ファイル削除 | ファイルが1件以上表示 | ファイルの削除ボタンをクリック | ファイルが一覧から削除される |
| 3 | ファイル複数追加 | フォーム表示済み | 複数ファイルを選択 | 選択した全ファイルが一覧に追加される |

#### IT1-UI-004: フォーム送信

| No | テスト項目 | 前提条件 | 操作手順 | 期待結果 |
|----|-----------|----------|----------|----------|
| 1 | 更新ボタン活性化 | 必須項目がすべて入力済み | 更新ボタンの状態確認 | 更新ボタンがクリック可能 |
| 2 | 更新成功時の遷移 | バリデーション通過 | 更新ボタンをクリック | 更新成功後、詳細画面へ遷移 |
| 3 | 更新中のローディング | バリデーション通過 | 更新ボタンをクリック | ローディング表示、ボタン非活性化 |
| 4 | キャンセル操作 | フォーム編集中 | キャンセルボタンをクリック | 詳細画面へ遷移（変更破棄） |

#### IT1-UI-005: 認証・認可表示

| No | テスト項目 | 前提条件 | 操作手順 | 期待結果 |
|----|-----------|----------|----------|----------|
| 1 | 未認証時の表示 | 未ログイン状態 | 編集画面URLに直接アクセス | UnauthorizedUIが表示される |
| 2 | 権限なし時の表示 | 閲覧権限のみのユーザー | 編集画面URLにアクセス | ForbiddenUIが表示される |
| 3 | 設計者権限での表示 | 設計者ロールを持つユーザー | 編集画面にアクセス | 編集フォームが表示される |
| 4 | 管理者権限での表示 | 管理者ユーザー | 編集画面にアクセス | 編集フォームが表示される |

### 異常系

#### IT1-UI-E01: 画面表示エラー

| No | テスト項目 | 前提条件 | 操作手順 | 期待結果 |
|----|-----------|----------|----------|----------|
| 1 | 存在しないテストケース | 削除済みのtidを指定 | 編集画面にアクセス | エラーメッセージ表示（「テストケースが見つかりません」） |
| 2 | 不正なgroupId形式 | 不正なgroupIdをURLに指定 | 画面アクセス | エラーメッセージ表示 |
| 3 | API通信エラー | ネットワーク切断状態 | 画面アクセス | エラーメッセージ表示、リトライ案内 |
| 4 | サーバーエラー | API側で500エラー発生 | 画面アクセス | エラーメッセージ表示 |

#### IT1-UI-E02: バリデーションエラー

| No | テスト項目 | 前提条件 | 操作手順 | 期待結果 |
|----|-----------|----------|----------|----------|
| 1 | 必須項目未入力 | 第1階層を空にする | 更新ボタンをクリック | バリデーションエラー表示、該当フィールドがハイライト |
| 2 | 文字数超過 | 第1階層に256文字以上入力 | 更新ボタンをクリック | バリデーションエラー表示（255文字以下） |
| 3 | ファイル未添付 | 制御仕様書を0件にする | 更新ボタンをクリック | バリデーションエラー表示（1つ以上必須） |
| 4 | テスト内容空行 | テストケース欄を空のまま | 更新ボタンをクリック | バリデーションエラー表示 |
| 5 | TID形式不正 | 不正な形式のTIDを指定 | フォーム送信 | バリデーションエラー表示 |

#### IT1-UI-E03: ファイル操作エラー

| No | テスト項目 | 前提条件 | 操作手順 | 期待結果 |
|----|-----------|----------|----------|----------|
| 1 | ファイルサイズ超過 | 10MBを超えるファイルを用意 | ファイルを選択 | エラーメッセージ表示 |
| 2 | 不正なファイル形式 | 許可されていない拡張子のファイル | ファイルを選択 | エラーメッセージ表示 |
| 3 | ファイルアップロード失敗 | ストレージ接続エラー状態 | ファイルをアップロード | エラーメッセージ表示 |

#### IT1-UI-E04: 更新処理エラー

| No | テスト項目 | 前提条件 | 操作手順 | 期待結果 |
|----|-----------|----------|----------|----------|
| 1 | API通信タイムアウト | ネットワーク遅延状態 | 更新ボタンをクリック | タイムアウトエラー表示 |
| 2 | 同時編集競合 | 他ユーザーが同時に更新 | 更新ボタンをクリック | 競合エラー表示（必要に応じて） |
| 3 | セッション切れ | セッション有効期限切れ | 更新ボタンをクリック | 認証エラー、ログイン画面へリダイレクト |

---

## IT1結合テスト（API）

### 正常系

#### IT1-API-001: GET /api/test-groups/[groupId]/cases/[tid]

| No | テスト項目 | 前提条件 | リクエスト | 期待結果 |
|----|-----------|----------|-----------|----------|
| 1 | テストケース取得成功 | 対象データが存在 | GET /api/test-groups/1/cases/1-1-1-1 | 200 OK、テストケース詳細JSON |
| 2 | テスト内容含む取得 | テスト内容が複数存在 | 同上 | testContents配列に全件含まれる |
| 3 | ファイル情報含む取得 | ファイルが登録済み | 同上 | controlSpecFiles, dataFlowFiles配列にファイル情報 |
| 4 | 管理者権限での取得 | 管理者ユーザー | 同上 | 200 OK |
| 5 | 閲覧権限での取得 | 閲覧者ロール | 同上 | 200 OK |

#### IT1-API-002: PUT /api/test-groups/[groupId]/cases/[tid]

| No | テスト項目 | 前提条件 | リクエスト | 期待結果 |
|----|-----------|----------|-----------|----------|
| 1 | 基本情報更新 | 編集権限あり | PUT（first_layer等を変更） | 200 OK、DBが更新される |
| 2 | テスト内容追加 | 編集権限あり | PUT（testContentsに新規行追加） | 200 OK、tt_test_contentsに追加 |
| 3 | テスト内容更新 | 既存テスト内容あり | PUT（testContentsを変更） | 200 OK、tt_test_contentsが更新 |
| 4 | テスト内容削除 | 削除対象行あり | PUT（deletedTestContentsに指定） | 200 OK、対象行がis_deleted=true |
| 5 | 複合更新 | 編集権限あり | PUT（追加・更新・削除を同時実行） | 200 OK、すべての変更が反映 |
| 6 | 管理者による更新 | 管理者ユーザー | PUT | 200 OK |
| 7 | 設計者による更新 | 設計者ロール | PUT | 200 OK |

#### IT1-API-003: DELETE /api/test-groups/[groupId]/cases/[tid]

| No | テスト項目 | 前提条件 | リクエスト | 期待結果 |
|----|-----------|----------|-----------|----------|
| 1 | テストケース削除成功 | 対象データが存在 | DELETE /api/test-groups/1/cases/1-1-1-1 | 200 OK、関連データすべて削除 |
| 2 | 関連ファイル削除 | ファイルが登録済み | DELETE | ストレージからファイル削除 |
| 3 | 関連テスト内容削除 | テスト内容が存在 | DELETE | tt_test_contents削除 |
| 4 | 関連テスト結果削除 | テスト結果が存在 | DELETE | tt_test_results削除 |
| 5 | 関連エビデンス削除 | エビデンスが存在 | DELETE | tt_test_evidences削除 |

#### IT1-API-004: POST /api/files/test-info

| No | テスト項目 | 前提条件 | リクエスト | 期待結果 |
|----|-----------|----------|-----------|----------|
| 1 | ファイルアップロード成功 | 編集権限あり | POST（FormData） | 200 OK、ファイルIDが返却 |
| 2 | 複数ファイル連続アップロード | 編集権限あり | POST（2回連続） | 両ファイルにユニークなfile_no |
| 3 | 制御仕様書アップロード | fileType=controlSpec | POST | file_type=controlSpecで保存 |
| 4 | データフローアップロード | fileType=dataFlow | POST | file_type=dataFlowで保存 |

#### IT1-API-005: DELETE /api/files/test-info

| No | テスト項目 | 前提条件 | リクエスト | 期待結果 |
|----|-----------|----------|-----------|----------|
| 1 | ファイル削除成功 | ファイルが存在 | DELETE（fileId指定） | 200 OK、DB・ストレージから削除 |
| 2 | ストレージ削除確認 | ファイルが存在 | DELETE | ストレージからファイルが削除される |

### 異常系

#### IT1-API-E01: 認証・認可エラー

| No | テスト項目 | 前提条件 | リクエスト | 期待結果 |
|----|-----------|----------|-----------|----------|
| 1 | 未認証でGET | 認証トークンなし | GET | 401 Unauthorized |
| 2 | 未認証でPUT | 認証トークンなし | PUT | 401 Unauthorized |
| 3 | 未認証でDELETE | 認証トークンなし | DELETE | 401 Unauthorized |
| 4 | 閲覧者でPUT | 閲覧者ロール | PUT | 403 Forbidden |
| 5 | 閲覧者でDELETE | 閲覧者ロール | DELETE | 403 Forbidden |
| 6 | 実施者でPUT | 実施者ロール | PUT | 403 Forbidden |
| 7 | 無効トークン | 期限切れトークン | 任意 | 401 Unauthorized |
| 8 | 他グループへのアクセス | 権限のないグループ | GET | 403 Forbidden |

#### IT1-API-E02: リクエストバリデーションエラー

| No | テスト項目 | 前提条件 | リクエスト | 期待結果 |
|----|-----------|----------|-----------|----------|
| 1 | groupId形式不正 | - | GET /api/test-groups/abc/cases/1-1-1-1 | 400 Bad Request |
| 2 | tid形式不正 | - | GET /api/test-groups/1/cases/invalid | 400 Bad Request |
| 3 | 必須フィールド欠落 | - | PUT（first_layerなし） | 400 Bad Request |
| 4 | 文字数超過 | - | PUT（first_layer=256文字） | 400 Bad Request |
| 5 | 不正なJSON | - | PUT（不正なJSONボディ） | 400 Bad Request |
| 6 | 空のtestContents | - | PUT（testContents=[]） | 400 Bad Request |

#### IT1-API-E03: データ存在エラー

| No | テスト項目 | 前提条件 | リクエスト | 期待結果 |
|----|-----------|----------|-----------|----------|
| 1 | 存在しないgroupId | 該当グループなし | GET | 404 Not Found |
| 2 | 存在しないtid | 該当テストケースなし | GET | 404 Not Found |
| 3 | 削除済みテストケース | is_deleted=true | GET | 404 Not Found |
| 4 | 存在しないファイルID | 該当ファイルなし | DELETE /api/files/test-info | 404 Not Found |

#### IT1-API-E04: サーバーエラー

| No | テスト項目 | 前提条件 | リクエスト | 期待結果 |
|----|-----------|----------|-----------|----------|
| 1 | DB接続エラー | DB接続不可状態 | GET | 500 Internal Server Error |
| 2 | トランザクション失敗 | 更新中にエラー | PUT | 500 Internal Server Error、ロールバック |
| 3 | ストレージ接続エラー | S3接続不可 | POST /api/files/test-info | 500 Internal Server Error |
| 4 | ファイル削除失敗 | ストレージエラー | DELETE /api/files/test-info | 500 Internal Server Error |

---

## IT2結合テスト

### 正常系

#### IT2-001: テストケース編集フロー

| No | テスト項目 | シナリオ | 期待結果 |
|----|-----------|----------|----------|
| 1 | 基本編集フロー | 1. テストケース一覧から編集画面へ遷移<br>2. 第1階層を変更<br>3. 更新ボタンをクリック<br>4. 詳細画面で確認 | 変更内容がDBに保存され、詳細画面に反映 |
| 2 | テスト内容追加フロー | 1. 編集画面を開く<br>2. テスト内容行を追加<br>3. テストケース・期待値を入力<br>4. 更新 | 新しいテスト内容がtt_test_contentsに追加 |
| 3 | テスト内容削除フロー | 1. 編集画面を開く<br>2. 既存テスト内容行を削除<br>3. 更新 | 対象行がis_deleted=trueに更新 |
| 4 | ファイル追加フロー | 1. 編集画面を開く<br>2. 制御仕様書ファイルを追加<br>3. 更新 | ファイルがストレージにアップロード、DBに記録 |
| 5 | ファイル削除フロー | 1. 編集画面を開く<br>2. 既存ファイルを削除<br>3. 更新 | ファイルがストレージ・DBから削除 |
| 6 | 複合編集フロー | 1. 基本情報を変更<br>2. テスト内容を追加・削除<br>3. ファイルを追加・削除<br>4. 更新 | すべての変更がトランザクションで一括反映 |

#### IT2-002: 権限別操作フロー

| No | テスト項目 | シナリオ | 期待結果 |
|----|-----------|----------|----------|
| 1 | 管理者による編集 | 管理者ユーザーで任意のテストケースを編集 | 編集・保存が正常に完了 |
| 2 | 設計者による編集 | 設計者ロールを持つグループのテストケースを編集 | 編集・保存が正常に完了 |
| 3 | グループ作成者による編集 | 自身が作成したグループのテストケースを編集 | 編集・保存が正常に完了 |

#### IT2-003: 画面遷移フロー

| No | テスト項目 | シナリオ | 期待結果 |
|----|-----------|----------|----------|
| 1 | 一覧→編集→詳細 | 1. テストケース一覧で編集クリック<br>2. 編集して保存<br>3. 詳細画面表示 | 正常に遷移、データ整合性維持 |
| 2 | 編集キャンセル | 1. 編集画面で変更<br>2. キャンセルボタン | 詳細画面へ遷移、変更は破棄 |
| 3 | ブラウザバック | 1. 編集画面で変更<br>2. ブラウザバック | クリーンアップ処理実行、前画面へ |

#### IT2-004: データ整合性確認

| No | テスト項目 | シナリオ | 期待結果 |
|----|-----------|----------|----------|
| 1 | 更新日時の更新 | テストケースを編集・保存 | updated_atが現在時刻に更新 |
| 2 | 関連データの整合性 | テスト内容を追加して保存 | test_group_id, tidが正しく設定 |
| 3 | ファイル番号の採番 | 複数ファイルを連続アップロード | file_noが重複なく採番 |

### 異常系

#### IT2-E01: 操作エラーシナリオ

| No | テスト項目 | シナリオ | 期待結果 |
|----|-----------|----------|----------|
| 1 | セッション切れ中の編集 | 1. 編集画面を開いたまま長時間放置<br>2. セッション切れ<br>3. 更新ボタンクリック | 認証エラー表示、ログイン画面へ誘導 |
| 2 | 削除済みデータの編集 | 1. 編集画面を開く<br>2. 他ユーザーがテストケースを削除<br>3. 更新ボタンクリック | エラーメッセージ表示（データが存在しません） |
| 3 | ネットワーク切断中の操作 | 1. 編集中にネットワーク切断<br>2. 更新ボタンクリック | エラーメッセージ表示、リトライ案内 |
| 4 | 大量データ更新 | 1. テスト内容を100行追加<br>2. 更新 | 正常に処理（タイムアウトしない）またはエラーメッセージ |

#### IT2-E02: 権限エラーシナリオ

| No | テスト項目 | シナリオ | 期待結果 |
|----|-----------|----------|----------|
| 1 | 権限変更後の操作 | 1. 設計者権限で編集画面を開く<br>2. 管理者が権限を閲覧者に変更<br>3. 更新ボタンクリック | 403エラー表示 |
| 2 | URLダイレクトアクセス | 権限のないユーザーが編集画面URLに直接アクセス | ForbiddenUI表示 |

#### IT2-E03: データ不整合シナリオ

| No | テスト項目 | シナリオ | 期待結果 |
|----|-----------|----------|----------|
| 1 | ファイルアップロード後の更新失敗 | 1. ファイルをアップロード<br>2. 更新処理でDBエラー | アップロード済みファイルがクリーンアップされる（または孤立ファイル対策） |
| 2 | 部分的な削除失敗 | 1. テスト内容削除を含む更新<br>2. トランザクション中にエラー | ロールバックにより元の状態維持 |

---

## ログテストについて

### 結論

**結合テスト（IT1/IT2）においてログ専用のテストケースは原則不要です。**

### 理由

1. **ログは副作用であり、主要なビジネスロジックではない**
   - ログ出力の有無や内容は、機能の正常動作に影響しない
   - ログが出力されなくても、機能自体は正常に動作する

2. **ログの単体テストで十分**
   - ログユーティリティ（`server-logger.ts`, `client-logger.ts`, `database-logger.ts`）の単体テストでログ出力機能を検証
   - 結合テストでは「ログが正しく出力されるか」ではなく「機能が正しく動作するか」を検証すべき

3. **テストのメンテナンスコスト**
   - ログメッセージは頻繁に変更される可能性がある
   - ログ内容を結合テストで検証すると、変更のたびにテストも修正が必要

### 例外的にログテストが必要なケース

以下の場合は、ログに関するテストケースを追加することを検討してください：

| ケース | 理由 | テスト観点 |
|--------|------|-----------|
| **監査ログ要件がある場合** | コンプライアンス上、特定操作のログ出力が必須 | 操作時に監査ログが出力されること |
| **ログベースのアラート** | ログ出力をトリガーにした監視・アラートがある | エラー時に適切なログレベルで出力 |
| **CloudWatch連携の検証** | 本番環境でのログ転送が重要な場合 | ログがCloudWatchに正しく送信される |
| **デバッグ必須情報** | 障害調査に必要な情報がログに含まれる | ユーザーID、リクエストID等が含まれる |

### 推奨アプローチ

1. **本システムの場合**
   - `database-logger.ts`の`logAPIEndpoint`、`logDatabaseQuery`は運用監視目的
   - 結合テスト時は「ログが出力されること」ではなく「APIが正常に動作すること」を検証
   - ログ関連は単体テストレベルで担保

2. **ログを確認したい場合**
   - IT2のシナリオテスト実行時に、副次的にログを目視確認
   - 専用のテストケースは作成せず、実行ログとして記録を残す程度

### 参考: 現在のログ出力箇所

| 処理 | ログ種別 | 出力内容 |
|------|---------|---------|
| API呼び出し | `logAPIEndpoint` | method, endpoint, userId, statusCode, executionTime |
| DB操作 | `logDatabaseQuery` | operation, table, executionTime, rowsAffected |
| フロントエンド | `clientLogger` | 画面操作、エラー情報 |

これらは運用時の監視・デバッグ用であり、結合テストでの検証対象外とします。

---

## 付録

### テストデータ要件

| データ種別 | 説明 |
|-----------|------|
| テストグループ | 最低3件（管理者作成、設計者権限あり、権限なし） |
| テストケース | 各グループに最低2件 |
| テスト内容 | 各テストケースに最低3行 |
| ファイル | 各テストケースに制御仕様書・データフロー各1件以上 |
| ユーザー | 管理者、テストマネージャー、一般ユーザー各1名以上 |

### 使用ツール

| ツール | 用途 |
|--------|------|
| Jest + React Testing Library | フロントエンドIT1テスト |
| Supertest | API IT1テスト |
| Playwright / Cypress | IT2 E2Eテスト |

---

**作成日**: 2026-02-05
**対象画面**: テストケース編集画面 (`/testGroup/[groupId]/testCase/[tid]/edit`)
