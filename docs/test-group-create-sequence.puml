@startuml Test Group Create Flow
title テストグループ新規作成画面のシーケンス図（最新版）
skinparam sequenceParticipant underline

actor "ユーザー" as user
participant "ブラウザ" as browser
participant "新規作成画面\n(Next.js Client)" as create_screen
participant "Server Action\n(action.ts)" as server_action
participant "API Route\n/api/test-groups" as api
participant "API Route\n/api/tags" as tags_api
database "AWS RDS\n(PostgreSQL)" as db

user ->> browser: 新規作成画面にアクセス
activate browser
browser ->> create_screen: ページロード
activate create_screen

note over create_screen: useEffect で初期処理\n- セッション確認\n- タグ一覧取得\n- Loading表示

create_screen ->> tags_api: GET /api/tags
activate tags_api

note over tags_api: 認証確認\n- requireAuth()

tags_api ->> db: タグ一覧取得
note over db: SELECT id, name\nFROM mt_tags\nWHERE is_deleted = FALSE\nORDER BY name

activate db
db -->> tags_api: タグ10件
deactivate db

tags_api -->> create_screen: {success: true,\ndata: [{id, name}, ...]}
deactivate tags_api

alt タグ取得失敗
  note over create_screen: Loading コンポーネント表示\nstate: tagError=エラーメッセージ
  create_screen -->> browser: エラーメッセージ表示\n「タグの取得に失敗しました」
  deactivate create_screen
else タグ取得成功
  note over create_screen: Loading コンポーネント表示OFF\nstate: tagLoading=false\nstate: tagError=null\n\nフォーム表示\n- 全入力項目\n- タグドロップダウン:  3段階\n  - Designer (test_role: 0)\n  - Executor (test_role: 1)\n  - Viewer (test_role: 2)

  create_screen -->> browser: フォーム表示
  deactivate create_screen

  user ->> browser: フォーム入力\n- OEM: \"OEM1\" (255文字以内)\n- 機種: \"Model1\" (255文字以内)\n- イベント: \"Event1\"\n- バリエーション: \"Var1\"\n- 仕向: \"Dest1\"\n- 制御仕様: \"Spec1\" (必須)\n- 試験開始日: \"2024-12-01\"\n- 試験終了日: \"2024-12-31\"\n- 不具合摘出予定数: \"10\" (0-9999)

  activate browser

  user ->> browser: タグ選択\n(各段階ごとに1つ選択可能)\n- Designer: \"田中太郎\"\n- Executor: \"佐藤次郎\"\n- Viewer: \"高橋三郎\"

  user ->> browser: 送信ボタンをクリック
  activate create_screen
  browser ->> create_screen: onSubmit(formData)

  note over create_screen: クライアント側バリデーション\n(Zod schema)\n\n- 全項目 required\n- oem, model, event,\n  variation, destination:\n  min(1) & max(255)\n- ng_plan_count:\n  >= 0 && <= 9999\n- startDate <= endDate

  alt バリデーション失敗
    create_screen -->> browser: エラーメッセージ表示\n(各入力欄下部に赤文字)\n例: \"OEMは必須項目です\"\n例: \"開始日は終了日以前である必要があります\"
    deactivate create_screen
  else バリデーション成功
    note over create_screen: tag_names 配列生成\n[\n  {tag_name: \"田中太郎\", test_role: 0},\n  {tag_name: \"佐藤次郎\", test_role: 1},\n  {tag_name: \"高橋三郎\", test_role: 2}\n]

    create_screen ->> server_action: createTestGroup({\noem: \"OEM1\",\nmodel: \"Model1\",\nevent: \"Event1\",\n...,\nng_plan_count: 10,\ntag_names: [{tag_name,\ntest_role: 0|1|2}, ...]\n})
    activate server_action

    note over server_action: Server Action処理\n(Next.js server-side)\ncookies() からセッション取得

    server_action ->> api: POST /api/test-groups\nHeader: Cookie設定
    activate api

    note over api: API Route処理開始

    api ->> api: 認証確認\n- requireAuth()\n\nセッション無効？\n-> 401 エラー返却

    alt 認証失敗
      api -->> server_action: {error: '認証が必要です'}\n(401)
      deactivate api
      server_action -->> create_screen: {success: false,\nerror: '認証が必要です'}
      deactivate server_action

      create_screen -->> browser: エラーメッセージ表示
      deactivate create_screen

    else 認証成功
      api ->> api: 権限チェック\n- isAdmin(user) ||\n  isTestManager(user)\n\nif (!isAdmin && !isTestManager)\n  return 403

      alt 権限不足
        api -->> server_action: {error: '権限がありません'}\n(403)
        deactivate api
        server_action -->> create_screen: {success: false,\nerror: '...'}
        deactivate server_action

        create_screen -->> browser: エラーメッセージ表示
        deactivate create_screen

      else 権限あり
        note over api: サーバー側バリデーション\n(POST /api/test-groups の検証)\n\n1. 必須フィールド チェック\n   - oem, model, event,\n     variation, destination,\n     specs, test_startdate,\n     test_enddate,\n     ng_plan_count\n\n2. 文字数チェック\n   - oem, model, event,\n     variation, destination:\n     max 255 chars\n\n3. 不具合数チェック\n   - ng_plan_count:\n     typeof number &&\n     >= 0 && <= 9999\n\n4. 日付チェック\n   - test_startdate &&\n     test_enddate?\n   - startDate <= endDate

        alt バリデーション失敗
          api -->> server_action: {success: false,\nerror: {message: 'すべての必須フィール...'}}\n(400)
          deactivate api
          server_action -->> create_screen: {success: false,\nerror: message}
          deactivate server_action

          create_screen -->> browser: エラーメッセージ表示\n「すべての必須フィールドを入力してください」
          deactivate create_screen

        else バリデーション成功
          note over api: トランザクション処理開始\n(transaction関数)

          api ->> db: テストグループ作成
          note over db: INSERT INTO tt_test_groups\n(oem, model, event,\nvariation, destination, specs,\ntest_startdate, test_enddate,\nng_plan_count,\ncreated_by, updated_by)\nVALUES ($1, $2, ..., $10, $10)\nRETURNING *

          activate db
          db -->> api: 新規グループレコード\n(id, 全カラム)
          deactivate db

          note over api: tag_names が配列で\nlength > 0 の場合

          api ->> db: タグID取得 & 関連付け\n(複数回 loop)
          note over db: 各 tag について:\n1. SELECT id FROM mt_tags\n   WHERE name = $1\n2. INSERT INTO\n   tt_test_group_tags(\n   test_group_id, tag_id,\n   test_role)\n   VALUES ($1, $2, $3)

          activate db
          db -->> api: 全タグ関連付け完了
          deactivate db

          note over api: トランザクション COMMIT

          api -->> server_action: {success: true,\ndata: {id: 123, ...}}\n(201)
          deactivate api

          note over server_action: レスポンス処理

          server_action -->> create_screen: {success: true,\ndata: {id: 123}}
          deactivate server_action

          note over create_screen: 成功状態\n- フォーム非表示\n- 成功メッセージ表示\n- 自動リダイレクト\n  3秒後に /testGroup へ

          create_screen -->> browser: 成功メッセージ表示\n「テストグループを作成しました」\n& リダイレクト
          deactivate create_screen

          browser -->> user: テストグループ一覧へ\n(新規グループが表示される)
          deactivate browser
        end
      end
    end
  end
end

note over user: テスト権限(test_role)の対応\n\n0: 設計者 - テストケース設計・編集可能\n1: 実施者 - テスト結果入力可能\n2: 閲覧者 - テスト情報閲覧のみ
@enduml
