# AWS環境構築手順書(開発・本番共通)

## 目次

1. [はじめに](#1-はじめに)
2. [前提条件](#2-前提条件)
3. [全体構成](#3-全体構成)
4. [構築手順](#4-構築手順)
   - [Step 1: VPCとネットワーク](#step-1-vpcとネットワーク)
   - [Step 2: セキュリティグループ](#step-2-セキュリティグループ)
   - [Step 3: RDS PostgreSQL](#step-3-rds-postgresql)
   - [Step 4: S3バケット](#step-4-s3バケット)
   - [Step 5: IAMロール](#step-5-iamロール)
   - [Step 6: ECRリポジトリ](#step-6-ecrリポジトリ)
   - [Step 7: ECSクラスターとタスク定義](#step-7-ecsクラスターとタスク定義)
   - [Step 8: SSL証明書(ACM)](#step-8-ssl証明書acm)
   - [Step 9: ロードバランサー(ALB)](#step-9-ロードバランサーalb)
   - [Step 10: Route 53 DNS設定](#step-10-route-53-dns設定)
   - [Step 11: CloudWatch設定](#step-11-cloudwatch設定)
   - [Step 12: AWS Batch(ユーザーインポート用)](#step-12-aws-batchユーザーインポート用)
5. [コスト最適化設定(開発環境)](#5-コスト最適化設定開発環境)
6. [トラブルシューティング](#6-トラブルシューティング)

---

## 1. はじめに

### 本ドキュメントの目的

このガイドは、ProofLinkシステムをAWS上に構築する手順を説明します。**全ての操作をAWSマネジメントコンソール(Webブラウザ)で実施**します。

### 対象環境

- **開発環境**: コストを抑えた小規模構成
- **本番環境**: 可用性とセキュリティを重視した構成

### 主な変更点(2026-01-23)

- ✅ **NATゲートウェイ不要**: パブリックサブネット上でECSを稼働させる構成に変更
- ✅ **AWSコンソール操作**: CLI不要、全てブラウザ操作で完結
- ✅ **開発環境のコスト削減**: 詳細な設定ガイドを追加
- ✅ **構築順序の最適化**: 依存関係を考慮した手順

---

## 2. 前提条件

### 2.1 必要なもの

| 項目 | 説明 |
|------|------|
| AWSアカウント | 管理者権限(AdministratorAccess)を持つアカウント |
| ドメイン | 本番環境用(例: prooflink.example.com) |
| メールアドレス | SSL証明書検証用 |

### 2.2 使用リージョン

本手順では **東京リージョン(ap-northeast-1)** を使用します。

### 2.3 事前確認事項

| 確認項目 | 開発環境 | 本番環境 |
|---------|---------|---------|
| 独自ドメイン | 不要(ALBのDNS名を使用) | 必要 |
| SSL証明書 | 不要(HTTP可) | 必要 |
| Multi-AZ構成 | 不要 | 推奨 |

---

## 3. 全体構成

### 3.1 NATゲートウェイを使わない構成

**従来の構成(NATゲートウェイあり)の課題:**
- NATゲートウェイのコストが月額3,000〜5,000円
- 小規模開発環境では過剰なリソース

**新しい構成(NATゲートウェイなし):**
- ECS FargateをパブリックサブネットにLaunch
- タスクにパブリックIPを自動割り当て
- インターネットゲートウェイ経由で外部通信

### 3.2 アーキテクチャ図

```
┌────────────────────────────────────────────────────────────┐
│                         AWS Cloud                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │           VPC (10.0.0.0/16)                          │  │
│  │                                                      │  │
│  │  ┌────────────────────────────────────────────────┐ │  │
│  │  │        Public Subnet 1 (10.0.1.0/24)          │ │  │
│  │  │                                                │ │  │
│  │  │  ┌──────────────┐     ┌──────────────────┐    │ │  │
│  │  │  │     ALB      │────▶│  ECS Fargate     │    │ │  │
│  │  │  │ (Internet-   │     │  (Public IP付き) │    │ │  │
│  │  │  │  facing)     │     └──────────────────┘    │ │  │
│  │  │  └──────────────┘                              │ │  │
│  │  │         │                                       │ │  │
│  │  │         │ インターネット                         │ │  │
│  │  │         │ ゲートウェイ経由                       │ │  │
│  │  └─────────┼───────────────────────────────────────┘ │  │
│  │            │                                         │  │
│  │  ┌─────────┼───────────────────────────────────────┐ │  │
│  │  │        Private Subnet 1 (10.0.11.0/24)        │ │  │
│  │  │         │                                       │ │  │
│  │  │         ▼                                       │ │  │
│  │  │  ┌──────────────────┐                          │ │  │
│  │  │  │ RDS PostgreSQL   │                          │ │  │
│  │  │  │ (プライベート)    │                          │ │  │
│  │  │  └──────────────────┘                          │ │  │
│  │  └──────────────────────────────────────────────── ┘ │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌────────────┐  ┌──────────────┐  ┌────────────────┐    │
│  │    S3      │  │     ECR      │  │  CloudWatch    │    │
│  │ (ストレージ)│  │ (コンテナ    │  │  (ログ・監視)  │    │
│  │            │  │  レジストリ) │  │                │    │
│  └────────────┘  └──────────────┘  └────────────────┘    │
└────────────────────────────────────────────────────────────┘
                         ▲
                         │ HTTPS
                         │
                  ┌──────┴──────┐
                  │   ユーザー   │
                  └─────────────┘
```

### 3.3 主要コンポーネント

| コンポーネント | 用途 | 配置場所 |
|--------------|------|---------|
| **ALB** | HTTPS終端、負荷分散 | パブリックサブネット |
| **ECS Fargate** | アプリケーション実行 | パブリックサブネット(パブリックIP付き) |
| **RDS PostgreSQL** | データベース | プライベートサブネット |
| **S3** | ファイルストレージ | マネージドサービス |
| **ECR** | Dockerイメージ保管 | マネージドサービス |

---

## 4. 構築手順

### Step 1: VPCとネットワーク

#### 1-1. VPCの作成

1. **AWSマネジメントコンソール**にログイン
2. 画面上部の検索バーで「**VPC**」と入力してVPCダッシュボードを開く
3. 左メニューから「**VPC**」→「**VPCを作成**」をクリック

**設定値:**

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| 作成するリソース | VPCなど | VPCなど |
| 名前タグの自動生成 | `prooflink-dev` | `prooflink-prod` |
| IPv4 CIDRブロック | `10.0.0.0/16` | `10.0.0.0/16` |
| IPv6 CIDRブロック | なし | なし |
| テナンシー | デフォルト | デフォルト |
| **アベイラビリティゾーン(AZ)の数** | **2** | **2** |
| **パブリックサブネットの数** | **2** | **2** |
| **プライベートサブネットの数** | **2** | **2** |
| **NATゲートウェイ** | **なし** | **なし** |
| **VPCエンドポイント** | S3ゲートウェイ | S3ゲートウェイ |

> **注意**: ALBとRDSは最低2つのAZにまたがるサブネットが必須です。開発環境でも2AZ構成としますが、各リソース(RDS、ECS)は1つのAZのみに配置するためコストは増加しません。

4. 「**VPCを作成**」をクリック

**作成されるリソース:**

開発環境・本番環境共通:
```
prooflink-dev-vpc (10.0.0.0/16)
├── prooflink-dev-subnet-public1-ap-northeast-1a (10.0.1.0/24)
├── prooflink-dev-subnet-public2-ap-northeast-1c (10.0.2.0/24)
├── prooflink-dev-subnet-private1-ap-northeast-1a (10.0.11.0/24)
├── prooflink-dev-subnet-private2-ap-northeast-1c (10.0.12.0/24)
├── prooflink-dev-igw (インターネットゲートウェイ)
└── ルートテーブル (パブリック用、プライベート用)
```

> **コスト補足**: サブネット自体は無料です。開発環境では各リソース(RDS、ECS)を1つのAZにのみ配置するため、2AZ構成でもコストは増加しません。

> **重要**: NATゲートウェイは「なし」を選択してください。これにより月額約3,000〜5,000円のコストを削減できます。

---

### Step 2: セキュリティグループ

#### 2-1. ALB用セキュリティグループ

1. 「**VPC**」→「**セキュリティグループ**」→「**セキュリティグループを作成**」

| 項目 | 値 |
|------|-----|
| セキュリティグループ名 | `prooflink-alb-sg` |
| 説明 | Security group for ALB |
| VPC | `prooflink-dev-vpc` または `prooflink-prod-vpc` |

**インバウンドルール:**

開発環境:
| タイプ | ポート | ソース | 説明 |
|--------|--------|--------|------|
| HTTP | 80 | 0.0.0.0/0 | 開発環境はHTTP許可 |
| HTTPS | 443 | 0.0.0.0/0 | HTTPS |

本番環境:
| タイプ | ポート | ソース | 説明 |
|--------|--------|--------|------|
| HTTPS | 443 | 0.0.0.0/0 | HTTPSのみ許可 |

**アウトバウンドルール:**
| タイプ | ポート | 送信先 | 説明 |
|--------|--------|--------|------|
| すべてのトラフィック | すべて | 0.0.0.0/0 | Allow all outbound |

#### 2-2. ECS用セキュリティグループ

| 項目 | 値 |
|------|-----|
| セキュリティグループ名 | `prooflink-ecs-sg` |
| 説明 | Security group for ECS tasks |
| VPC | `prooflink-dev-vpc` または `prooflink-prod-vpc` |

**インバウンドルール:**
| タイプ | ポート | ソース | 説明 |
|--------|--------|--------|------|
| カスタムTCP | 3000 | `prooflink-alb-sg` | ALBからのアクセスのみ許可 |

**アウトバウンドルール:**
| タイプ | ポート | 送信先 | 説明 |
|--------|--------|--------|------|
| すべてのトラフィック | すべて | 0.0.0.0/0 | 外部APIアクセス、ECRプル用 |

> **ポイント**: ECSタスクがパブリックIPを持つため、アウトバウンドで外部通信が可能になります。

#### 2-3. RDS用セキュリティグループ

| 項目 | 値 |
|------|-----|
| セキュリティグループ名 | `prooflink-rds-sg` |
| 説明 | Security group for RDS PostgreSQL |
| VPC | `prooflink-dev-vpc` または `prooflink-prod-vpc` |

**インバウンドルール:**
| タイプ | ポート | ソース | 説明 |
|--------|--------|--------|------|
| PostgreSQL | 5432 | `prooflink-ecs-sg` | ECSからのアクセスのみ |

**アウトバウンドルール:**
| タイプ | ポート | 送信先 | 説明 |
|--------|--------|--------|------|
| すべてのトラフィック | すべて | 0.0.0.0/0 | Allow all outbound |

---

### Step 3: RDS PostgreSQL

#### 3-1. サブネットグループの作成

1. 「**RDS**」→「**サブネットグループ**」→「**DBサブネットグループを作成**」

| 項目 | 値 |
|------|-----|
| 名前 | `prooflink-db-subnet-group` |
| 説明 | Subnet group for prooflink database |
| VPC | `prooflink-dev-vpc` または `prooflink-prod-vpc` |
| アベイラビリティゾーン | プライベートサブネットのあるAZを選択 |
| サブネット | **プライベートサブネット**を**2つとも**選択 |

> **重要**: RDSは最低2つのAZにまたがるサブネットが必須のため、開発環境でも2つのプライベートサブネットを選択してください。

#### 3-2. RDSインスタンスの作成

1. 「**RDS**」→「**データベース**」→「**データベースの作成**」

**エンジンのオプション:**

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| エンジンタイプ | PostgreSQL | PostgreSQL |
| エンジンバージョン | PostgreSQL 15.x | PostgreSQL 15.x |
| テンプレート | **開発/テスト** | **本番稼働用** |

**設定:**

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| DBインスタンス識別子 | `prooflink-dev-db` | `prooflink-prod-db` |
| マスターユーザー名 | `postgres` | `postgres` |
| マスターパスワード | (強力なパスワードを設定) | (強力なパスワードを設定) |

> **パスワードの要件**: 最低8文字、英数字記号を含む

**インスタンスの設定:**

| 項目 | 開発環境(コスト重視) | 本番環境(性能重視) |
|------|-------------------|------------------|
| DBインスタンスクラス | **db.t4g.micro** (2vCPU 1GB)<br>月額約1,500円 | **db.t4g.medium** (2vCPU 4GB)<br>月額約6,000円 |
| ストレージタイプ | **gp3** | **gp3** |
| ストレージ割り当て | **20 GiB** | **100 GiB** |
| ストレージ自動スケーリング | 無効 | 有効(最大500GiB) |
| IOPS | 3000 (gp3デフォルト) | 3000〜12000 |

**可用性と耐久性:**

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| Multi-AZ配置 | **スタンドバロン**(Single-AZ) | **Multi-AZ DBインスタンス** |

**接続:**

| 項目 | 値 |
|------|-----|
| VPC | `prooflink-dev-vpc` または `prooflink-prod-vpc` |
| DBサブネットグループ | `prooflink-db-subnet-group` |
| **パブリックアクセス** | **なし** (重要) |
| VPCセキュリティグループ | `prooflink-rds-sg` |
| データベースポート | 5432 |

**追加設定:**

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| 最初のデータベース名 | `prooflink_dev` | `prooflink_prod` |
| **自動バックアップ** | **無効** (コスト削減) | **有効** |
| バックアップ保持期間 | - | 7日 |
| **暗号化** | **無効** | **有効(推奨)** |
| **削除保護** | 無効 | **有効** |
| **Performance Insights** | 無効 | 有効 |

2. 「**データベースの作成**」をクリック

作成には10〜15分かかります。ステータスが「**利用可能**」になるまで待ちます。

#### 3-3. データベース接続情報の確認

1. 作成したRDSインスタンスをクリック
2. 「**接続とセキュリティ**」タブで**エンドポイント**をコピー

例: `prooflink-dev-db.xxxxx.ap-northeast-1.rds.amazonaws.com`

この情報は後ほどECSタスク定義で使用します。

---

### Step 4: S3バケット

#### 4-1. メインバケットの作成

1. 「**S3**」→「**バケットを作成**」

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| バケット名 | `prooflink-dev-files-{ランダム文字列}` | `prooflink-prod-files-{ランダム文字列}` |
| AWSリージョン | ap-northeast-1 | ap-northeast-1 |
| オブジェクト所有者 | ACL無効(推奨) | ACL無効(推奨) |
| **ブロックパブリックアクセス** | **すべてブロック** (必須) | **すべてブロック** (必須) |
| バケットのバージョニング | 無効 | 有効 |
| デフォルトの暗号化 | SSE-S3 | SSE-S3 |

> **バケット名の注意**: S3バケット名は全世界で一意である必要があります。`{ランダム文字列}`には日付やアカウントIDを使用すると良いでしょう(例: `20260123`、AWSアカウントIDなど)。

2. 「**バケットを作成**」をクリック

#### 4-2. フォルダ構造の作成

バケット内に以下のフォルダ構造を作成します:

1. 作成したS3バケットを開く
2. 「**フォルダの作成**」をクリックして以下を作成:

```
prooflink-dev-files-xxxxx/
├── evidences/          # テストエビデンスファイル
├── imports/            # CSVインポートファイル
├── control-specs/      # 制御仕様書
└── dataflows/          # データフロー図
```

#### 4-3. CORSの設定(アプリケーションから直接アップロードする場合)

1. バケットを選択
2. 「**アクセス許可**」タブ
3. 「**クロスオリジンリソース共有(CORS)**」→「**編集**」

```json
[
    {
        "AllowedHeaders": ["*"],
        "AllowedMethods": ["GET", "PUT", "POST", "DELETE"],
        "AllowedOrigins": [
            "http://localhost:3000",
            "https://your-alb-domain.amazonaws.com",
            "https://prooflink.example.com"
        ],
        "ExposeHeaders": ["ETag"]
    }
]
```

4. 「**変更を保存**」をクリック

---

### Step 5: IAMロール

#### 5-1. ECSタスク実行ロール

このロールは、ECSがECRからイメージをプルし、CloudWatch Logsにログを送信するために必要です。

1. 「**IAM**」→「**ロール**」→「**ロールを作成**」

| 項目 | 値 |
|------|-----|
| 信頼されたエンティティタイプ | AWSのサービス |
| ユースケース | Elastic Container Service → **Elastic Container Service Task** |

2. 「**次へ**」をクリック

**許可ポリシー:**
- `AmazonECSTaskExecutionRolePolicy` (AWSマネージドポリシー)

3. 「**次へ**」をクリック

| 項目 | 値 |
|------|-----|
| ロール名 | `prooflink-ecs-task-execution-role` |
| 説明 | Execution role for ECS tasks |

4. 「**ロールを作成**」をクリック

#### 5-2. ECSタスクロール

このロールは、アプリケーションがS3やRDSにアクセスするために必要です。

1. 「**IAM**」→「**ロール**」→「**ロールを作成**」

| 項目 | 値 |
|------|-----|
| 信頼されたエンティティタイプ | AWSのサービス |
| ユースケース | Elastic Container Service → **Elastic Container Service Task** |

2. 「**次へ**」をクリック(ポリシーは後で追加)

| 項目 | 値 |
|------|-----|
| ロール名 | `prooflink-ecs-task-role` |

3. 「**ロールを作成**」をクリック

4. 作成したロール `prooflink-ecs-task-role` をクリック

5. 「**許可を追加**」→「**インラインポリシーを作成**」

6. 「**JSON**」タブを選択して以下を貼り付け:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "S3Access",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::prooflink-*-files-*",
                "arn:aws:s3:::prooflink-*-files-*/*"
            ]
        },
        {
            "Sid": "CloudWatchLogs",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "arn:aws:logs:ap-northeast-1:*:log-group:/ecs/prooflink-*:*"
        }
    ]
}
```

7. 「**次へ**」をクリック

| 項目 | 値 |
|------|-----|
| ポリシー名 | `ProoflinkECSTaskPolicy` |

8. 「**ポリシーを作成**」をクリック

---

### Step 6: ECRリポジトリ

#### 6-1. アプリケーション用リポジトリの作成

1. 「**ECR**」→「**リポジトリ**」→「**リポジトリを作成**」

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| 可視性設定 | プライベート | プライベート |
| リポジトリ名 | `prooflink-dev-app` | `prooflink-prod-app` |
| タグのイミュータビリティ | 無効 | 有効(推奨) |
| プッシュ時のスキャン | 無効 | 有効(推奨) |
| 暗号化設定 | AES-256 | AES-256 |

2. 「**リポジトリを作成**」をクリック

#### 6-2. リポジトリURIの確認

作成したリポジトリをクリックして、**URI**をコピーします。

例: `123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/prooflink-dev-app`

この情報は後ほどDockerイメージのプッシュ時に使用します。

---

### Step 7: ECSクラスターとタスク定義

#### 7-1. ECSクラスターの作成

1. 「**ECS**」→「**クラスター**」→「**クラスターの作成**」

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| クラスター名 | `prooflink-dev-cluster` | `prooflink-prod-cluster` |
| インフラストラクチャ | AWS Fargate(サーバーレス) | AWS Fargate(サーバーレス) |
| Container Insights | オフ(コスト削減) | オン(推奨) |

2. 「**作成**」をクリック

#### 7-2. CloudWatch Logsグループの作成

1. 「**CloudWatch**」→「**ロググループ**」→「**ロググループを作成**」

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| ロググループ名 | `/ecs/prooflink-dev-app` | `/ecs/prooflink-prod-app` |
| ログの保持期間 | 3日 | 30日 |

2. 「**作成**」をクリック

#### 7-3. タスク定義の作成

1. 「**ECS**」→「**タスク定義**」→「**新しいタスク定義の作成**」

**基本設定:**

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| タスク定義ファミリー | `prooflink-dev-task` | `prooflink-prod-task` |
| 起動タイプ | AWS Fargate | AWS Fargate |
| OS/アーキテクチャ | Linux/X86_64 | Linux/X86_64 |
| **CPU** | **0.5 vCPU** (コスト削減) | **1 vCPU** |
| **メモリ** | **1 GB** (コスト削減) | **2 GB** |
| タスクロール | `prooflink-ecs-task-role` | `prooflink-ecs-task-role` |
| タスク実行ロール | `prooflink-ecs-task-execution-role` | `prooflink-ecs-task-execution-role` |

**コンテナの設定:**

| 項目 | 値 |
|------|-----|
| コンテナ名 | `prooflink-app` |
| **イメージURI** | `123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/prooflink-dev-app:latest` |
| ポートマッピング | コンテナポート: `3000`, プロトコル: TCP, 名前: `app-3000-tcp` |

**環境変数:**

| キー | 値 | 説明 |
|------|-----|------|
| NODE_ENV | `production` | Node.js実行環境 |
| NEXTAUTH_URL | `http://your-alb-dns-name` | アプリケーションURL |
| DATABASE_URL | `postgresql://postgres:パスワード@RDSエンドポイント:5432/prooflink_dev` | データベース接続文字列 |
| NEXTAUTH_SECRET | (ランダムな64文字以上の文字列) | NextAuth用シークレット |
| AWS_REGION | `ap-northeast-1` | AWSリージョン |
| AWS_S3_BUCKET_NAME | `prooflink-dev-files-xxxxx` | S3バケット名 |

> **NEXTAUTH_SECRETの生成**:
>
> Linuxの場合: `openssl rand -base64 64`
>
> Windowsの場合: PowerShellで `[Convert]::ToBase64String((1..64|%{Get-Random -Max 256}))`

**ログ設定:**

| 項目 | 値 |
|------|-----|
| ログドライバー | awslogs |
| awslogs-group | `/ecs/prooflink-dev-app` |
| awslogs-region | `ap-northeast-1` |
| awslogs-stream-prefix | `ecs` |

2. 「**作成**」をクリック

---

### Step 8: SSL証明書(ACM)

> **注意**: 開発環境でHTTPのみを使用する場合は、このステップをスキップできます。

#### 8-1. パブリック証明書のリクエスト

1. 「**Certificate Manager**」→「**証明書をリクエスト**」

| 項目 | 値 |
|------|-----|
| 証明書タイプ | パブリック証明書をリクエスト |

2. 「**次へ**」をクリック

| 項目 | 値 |
|------|-----|
| ドメイン名 | `prooflink.example.com` |
| 検証方法 | **DNS検証** (推奨) |

3. 「**リクエスト**」をクリック

#### 8-2. DNS検証の実施

1. 作成した証明書をクリック
2. 「**Route 53でレコードを作成**」ボタンをクリック(Route 53を使用している場合)
3. 検証が完了するまで5〜30分待機

証明書のステータスが「**発行済み**」になれば完了です。

---

### Step 9: ロードバランサー(ALB)

#### 9-1. ターゲットグループの作成

1. 「**EC2**」→「**ターゲットグループ**」→「**ターゲットグループの作成**」

| 項目 | 値 |
|------|-----|
| ターゲットタイプ | **IPアドレス** |
| ターゲットグループ名 | `prooflink-tg` |
| プロトコル | HTTP |
| ポート | 3000 |
| VPC | `prooflink-dev-vpc` または `prooflink-prod-vpc` |

**ヘルスチェック設定:**

| 項目 | 値 |
|------|-----|
| ヘルスチェックプロトコル | HTTP |
| ヘルスチェックパス | `/api/health` |
| 正常のしきい値 | 2 |
| 非正常のしきい値 | 3 |
| タイムアウト | 5秒 |
| 間隔 | 30秒 |
| 成功コード | 200 |

2. 「**次へ**」をクリック
3. ターゲットは後で登録するので、そのまま「**ターゲットグループの作成**」をクリック

#### 9-2. Application Load Balancerの作成

1. 「**EC2**」→「**ロードバランサー**」→「**ロードバランサーの作成**」
2. 「**Application Load Balancer**」の「**作成**」をクリック

**基本的な設定:**

| 項目 | 値 |
|------|-----|
| ロードバランサー名 | `prooflink-alb` |
| スキーム | **インターネット向け** |
| IPアドレスタイプ | IPv4 |

**ネットワークマッピング:**

| 項目 | 値 |
|------|-----|
| VPC | `prooflink-dev-vpc` または `prooflink-prod-vpc` |
| マッピング | **パブリックサブネット**を**2つとも**選択 |

> **重要**: ALBは最低2つのAZにまたがるサブネットが必須のため、開発環境でも2つのパブリックサブネットを選択してください。

**セキュリティグループ:**

| 項目 | 値 |
|------|-----|
| セキュリティグループ | `prooflink-alb-sg` |

**リスナーとルーティング:**

開発環境(HTTPのみ):
| プロトコル | ポート | デフォルトアクション |
|-----------|--------|-----------------|
| HTTP | 80 | `prooflink-tg`に転送 |

本番環境(HTTPS):
| プロトコル | ポート | デフォルトアクション |
|-----------|--------|-----------------|
| HTTP | 80 | HTTPSにリダイレクト(ポート443) |
| HTTPS | 443 | `prooflink-tg`に転送 |

HTTPS リスナーの追加設定:
| 項目 | 値 |
|------|-----|
| セキュリティポリシー | ELBSecurityPolicy-TLS13-1-2-2021-06 |
| デフォルトSSL/TLS証明書 | ACMで取得した証明書を選択 |

2. 「**ロードバランサーの作成**」をクリック

作成には数分かかります。ステータスが「**アクティブ**」になるまで待ちます。

#### 9-3. ALBのDNS名の確認

1. 作成したロードバランサーをクリック
2. 「**DNS名**」をコピー

例: `prooflink-alb-123456789.ap-northeast-1.elb.amazonaws.com`

このDNS名は開発環境でのアクセスに使用します。

---

### Step 10: Route 53 DNS設定

> **注意**: 本番環境で独自ドメインを使用する場合のみ必要です。

#### 10-1. Aレコードの作成

1. 「**Route 53**」→「**ホストゾーン**」→ドメイン(例: `example.com`)を選択
2. 「**レコードを作成**」をクリック

| 項目 | 値 |
|------|-----|
| レコード名 | `prooflink` |
| レコードタイプ | A - IPv4アドレス |
| エイリアス | はい |
| トラフィックのルーティング先 | Application Load Balancerへのエイリアス |
| リージョン | アジアパシフィック(東京) |
| ロードバランサー | `prooflink-alb` |

3. 「**レコードを作成**」をクリック

数分後、`https://prooflink.example.com` でアクセスできるようになります。

---

### Step 11: CloudWatch設定

#### 11-1. アラームの作成(本番環境推奨)

開発環境ではコスト削減のためスキップ可能です。

**ECS CPU使用率アラーム:**

1. 「**CloudWatch**」→「**アラーム**」→「**アラームの作成**」
2. 「**メトリクスの選択**」をクリック
3. 「**ECS**」→「**クラスター名, サービス名**」
4. `CPUUtilization` を選択

| 項目 | 値 |
|------|-----|
| 統計 | 平均 |
| 期間 | 5分 |
| しきい値のタイプ | 静的 |
| しきい値 | 80 |
| アラーム条件 | より大きい |

5. 「**次へ**」をクリック
6. SNSトピックを設定(通知先メールアドレス)
7. アラーム名: `prooflink-ecs-cpu-high`
8. 「**アラームの作成**」をクリック

---

### Step 12: AWS Batch(ユーザーインポート用)

#### 12-1. 概要

AWS Batchを使用して、大量のユーザーデータをCSVからインポートします。バッチジョブはFargateで実行され、S3からCSVを読み込み、PostgreSQLにデータを投入します。

**処理フロー:**
```
[Webアプリ] → [CSVをS3アップロード] → [AWS Batch起動] → [Fargateでバッチ実行]
                                                           ↓
                                                     [PostgreSQL更新]
                                                           ↓
                                                     [結果をS3保存]
```

**用途:**
- ユーザー情報の一括インポート(数千〜数万件)
- テストデータの一括登録
- 定期的なデータ同期処理

> **注意**: 開発環境でバッチ処理が不要な場合は、このステップをスキップできます。

#### 12-2. バッチ用セキュリティグループの作成

1. 「**VPC**」→「**セキュリティグループ**」→「**セキュリティグループを作成**」

| 項目 | 値 |
|------|-----|
| セキュリティグループ名 | `prooflink-batch-sg` |
| 説明 | Security group for AWS Batch |
| VPC | `prooflink-dev-vpc` または `prooflink-prod-vpc` |

**インバウンドルール:**
- 不要(バッチジョブは外部からアクセスされない)

**アウトバウンドルール:**
| タイプ | ポート | 送信先 | 説明 |
|--------|--------|--------|------|
| すべてのトラフィック | すべて | 0.0.0.0/0 | ECRプル、S3アクセス、外部API用 |

#### 12-3. RDSセキュリティグループの更新

バッチジョブからRDSへのアクセスを許可します。

1. 「**VPC**」→「**セキュリティグループ**」→ `prooflink-rds-sg` を選択
2. 「**インバウンドルール**」タブ→「**インバウンドルールを編集**」
3. 「**ルールを追加**」をクリック

| タイプ | ポート | ソース | 説明 |
|--------|--------|--------|------|
| PostgreSQL | 5432 | `prooflink-batch-sg` | Batchからのアクセス |

4. 「**ルールを保存**」をクリック

#### 12-4. Batch用IAMロールの作成

##### 12-4-1. Batch実行ロール

1. 「**IAM**」→「**ロール**」→「**ロールを作成**」

| 項目 | 値 |
|------|-----|
| 信頼されたエンティティタイプ | AWSのサービス |
| ユースケース | Elastic Container Service → **Elastic Container Service Task** |

2. 「**次へ**」をクリック

**許可ポリシー:**
- `AmazonECSTaskExecutionRolePolicy` (AWSマネージドポリシー)

3. 「**次へ**」をクリック

| 項目 | 値 |
|------|-----|
| ロール名 | `prooflink-batch-execution-role` |
| 説明 | Execution role for AWS Batch tasks |

4. 「**ロールを作成**」をクリック

##### 12-4-2. Batchタスクロール

1. 「**IAM**」→「**ロール**」→「**ロールを作成**」

| 項目 | 値 |
|------|-----|
| 信頼されたエンティティタイプ | AWSのサービス |
| ユースケース | Elastic Container Service → **Elastic Container Service Task** |

2. 「**次へ**」をクリック(ポリシーは後で追加)

| 項目 | 値 |
|------|-----|
| ロール名 | `prooflink-batch-task-role` |

3. 「**ロールを作成**」をクリック

4. 作成したロール `prooflink-batch-task-role` をクリック

5. 「**許可を追加**」→「**インラインポリシーを作成**」

6. 「**JSON**」タブを選択して以下を貼り付け:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "S3Access",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::prooflink-*-files-*",
                "arn:aws:s3:::prooflink-*-files-*/*"
            ]
        },
        {
            "Sid": "CloudWatchLogs",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "arn:aws:logs:ap-northeast-1:*:log-group:/aws/batch/prooflink-*:*"
        }
    ]
}
```

7. 「**次へ**」をクリック

| 項目 | 値 |
|------|-----|
| ポリシー名 | `ProoflinkBatchTaskPolicy` |

8. 「**ポリシーを作成**」をクリック

#### 12-5. Batch用ECRリポジトリの作成

1. 「**ECR**」→「**リポジトリ**」→「**リポジトリを作成**」

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| 可視性設定 | プライベート | プライベート |
| リポジトリ名 | `prooflink-dev-batch` | `prooflink-prod-batch` |
| タグのイミュータビリティ | 無効 | 有効(推奨) |
| プッシュ時のスキャン | 無効 | 有効(推奨) |
| 暗号化設定 | AES-256 | AES-256 |

2. 「**リポジトリを作成**」をクリック

#### 12-6. CloudWatch Logsグループの作成

1. 「**CloudWatch**」→「**ロググループ**」→「**ロググループを作成**」

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| ロググループ名 | `/aws/batch/prooflink-dev` | `/aws/batch/prooflink-prod` |
| ログの保持期間 | 3日 | 30日 |

2. 「**作成**」をクリック

#### 12-7. コンピューティング環境の作成

1. 「**AWS Batch**」→「**コンピューティング環境**」→「**作成**」

**基本設定:**

| 項目 | 値 |
|------|-----|
| オーケストレーションタイプ | マネージド |
| 名前 | `prooflink-compute-env` |

**インスタンス設定:**

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| プロビジョニングモデル | Fargate | Fargate |
| 最大vCPU | 4 | 16 |

**ネットワーク設定:**

| 項目 | 値 |
|------|-----|
| VPC | `prooflink-dev-vpc` または `prooflink-prod-vpc` |
| サブネット | **パブリックサブネット**を選択(2つとも) |
| セキュリティグループ | `prooflink-batch-sg` |

> **重要**: Batchジョブもパブリックサブネット+パブリックIP付きで実行します。これによりNATゲートウェイ不要でECRからイメージをプルできます。

2. 「**作成**」をクリック

#### 12-8. ジョブキューの作成

1. 「**AWS Batch**」→「**ジョブキュー**」→「**作成**」

| 項目 | 値 |
|------|-----|
| 名前 | `prooflink-job-queue` |
| 優先度 | 1 |
| 接続されたコンピューティング環境 | `prooflink-compute-env` を選択 |
| 順序 | 1 |

2. 「**作成**」をクリック

#### 12-9. ジョブ定義の作成

1. 「**AWS Batch**」→「**ジョブ定義**」→「**作成**」

**基本設定:**

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| オーケストレーションタイプ | Fargate | Fargate |
| 名前 | `prooflink-dev-user-import` | `prooflink-prod-user-import` |
| 実行タイムアウト | 3600秒(1時間) | 7200秒(2時間) |

**コンテナ設定:**

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| イメージ | `{アカウントID}.dkr.ecr.ap-northeast-1.amazonaws.com/prooflink-dev-batch:latest` | `{アカウントID}.dkr.ecr.ap-northeast-1.amazonaws.com/prooflink-prod-batch:latest` |
| コマンド | `node,dist/batch/user-import.js` | `node,dist/batch/user-import.js` |
| vCPU | 0.5 | 1 |
| メモリ | 1 GB | 2 GB |
| ジョブロール | `prooflink-batch-task-role` | `prooflink-batch-task-role` |
| 実行ロール | `prooflink-batch-execution-role` | `prooflink-batch-execution-role` |

**環境変数:**

| キー | 値 |
|------|-----|
| NODE_ENV | `production` |
| DATABASE_URL | RDSの接続文字列 |
| AWS_REGION | `ap-northeast-1` |
| AWS_S3_BUCKET_NAME | S3バケット名 |

**ログ設定:**

| 項目 | 値 |
|------|-----|
| ログドライバー | awslogs |
| awslogs-group | `/aws/batch/prooflink-dev` または `/aws/batch/prooflink-prod` |
| awslogs-region | `ap-northeast-1` |
| awslogs-stream-prefix | `batch` |

2. 「**作成**」をクリック

#### 12-10. バッチジョブの実行テスト

バッチイメージをビルドしてECRにプッシュした後、手動でジョブを実行してテストします。

1. 「**AWS Batch**」→「**ジョブ**」→「**新しいジョブを送信**」

| 項目 | 値 |
|------|-----|
| 名前 | `test-user-import-{日付}` |
| ジョブ定義 | `prooflink-dev-user-import:1` |
| ジョブキュー | `prooflink-job-queue` |

**ジョブのオーバーライド(オプション):**

| キー | 値 |
|------|-----|
| IMPORT_FILE_KEY | `imports/users-20260123.csv` |

2. 「**送信**」をクリック

3. ジョブのステータスを確認:
   - SUBMITTED: キューに追加済み
   - RUNNABLE: 実行可能
   - STARTING: 起動中
   - RUNNING: 実行中
   - SUCCEEDED: 成功
   - FAILED: 失敗

4. ログを確認:
   - ジョブをクリック
   - 「**ログストリーム名**」のリンクをクリック
   - CloudWatch Logsでログを確認

---

## 5. コスト最適化設定(開発環境)

### 5.1 開発環境の月額コスト目安

| リソース | 設定 | 月額概算(東京リージョン) |
|---------|------|---------------------|
| **RDS PostgreSQL** | db.t4g.micro, 20GB, Single-AZ | **¥1,500** |
| **ECS Fargate** | 0.5vCPU, 1GB, 24時間稼働 | **¥1,800** |
| **ALB** | 最小構成 | **¥2,500** |
| **S3** | 10GB, 少量リクエスト | **¥100** |
| **ECR** | 10GB (アプリ) + 5GB (バッチ) | **¥150** |
| **CloudWatch Logs** | 3日保持, 1GB/月 | **¥100** |
| **データ転送** | 1GB/月 | **¥10** |
| **AWS Batch** | 月1回実行, 0.5vCPU, 1GB, 30分 | **¥5** |
| **合計** | | **約¥6,165/月** |

> **NATゲートウェイなしの効果**: 従来構成では月額約3,000〜5,000円追加でしたが、パブリックサブネット構成により削減できます。

### 5.2 RDSのコスト削減設定

#### 自動停止・起動スケジュール(開発時間外は停止)

**Systems Manager Automationを使用:**

1. 「**Systems Manager**」→「**オートメーション**」→「**オートメーションを実行**」
2. ドキュメント: `AWS-StopRdsInstance`
3. スケジュール: EventBridgeで毎日22:00に停止
4. ドキュメント: `AWS-StartRdsInstance`
5. スケジュール: EventBridgeで毎日9:00に起動

**効果**: 夜間・休日停止で約50%のコスト削減

#### ストレージ自動スケーリングを無効化

開発環境では固定20GBで十分です。

### 5.3 ECSのコスト削減設定

#### タスクサイズの最小化

| 項目 | 推奨設定 |
|------|---------|
| CPU | 0.5 vCPU (最小) |
| メモリ | 1 GB (最小) |

#### Auto Scalingを無効化

開発環境では常時1タスクで十分です。

### 5.4 S3のコスト削減設定

#### ライフサイクルポリシーの設定

1. S3バケットを選択
2. 「**管理**」タブ→「**ライフサイクルルールを作成**」

| 項目 | 値 |
|------|-----|
| ルール名 | `delete-old-imports` |
| ルールスコープ | `imports/` プレフィックス |
| アクション | 現在のバージョンを完全削除 |
| 日数 | 30日 |

**効果**: 古いインポートファイルを自動削除してストレージコストを削減

### 5.5 CloudWatch Logsのコスト削減

#### ログ保持期間の短縮

開発環境: 3日
本番環境: 30日以上

#### 不要なログの削減

```javascript
// 本番環境以外では詳細ログを無効化
if (process.env.NODE_ENV !== 'production') {
  console.log = () => {};
}
```

### 5.6 その他のコスト削減Tips

| 項目 | 方法 | 効果 |
|------|------|------|
| **未使用リソースの削除** | 定期的に未使用のEBSスナップショット、AMI、EIPを削除 | 月数百円〜 |
| **リザーブドインスタンス** | 本番環境で1年以上使用する場合は検討 | 30〜40%削減 |
| **Savings Plans** | Fargate含む全体的なコスト削減 | 最大17%削減 |

---

## 6. トラブルシューティング

### 6.1 ECSタスクが起動しない

#### 原因1: ECRイメージがプルできない

**確認方法:**
1. 「**ECS**」→クラスター→サービス→「**イベント**」タブ
2. エラーメッセージを確認

```
CannotPullContainerError: pull image manifest has been retried 5 time(s)
```

**解決策:**
- ECSタスク実行ロールに `AmazonECSTaskExecutionRolePolicy` がアタッチされているか確認
- ECRリポジトリにイメージが存在するか確認
- イメージURIが正しいか確認

#### 原因2: パブリックIPが割り当てられていない

**確認方法:**
サービス作成時に「**パブリックIPの自動割り当て**」が有効になっているか確認

**解決策:**
1. 「**ECS**」→サービス→「**更新**」
2. 「**ネットワーク構成**」→「**パブリックIPの自動割り当て**」を「**ENABLED**」に変更

#### 原因3: データベース接続エラー

**確認方法:**
CloudWatch Logsでエラーを確認

```
Error: connect ETIMEDOUT
```

**解決策:**
- RDSセキュリティグループに `prooflink-ecs-sg` からのポート5432が許可されているか確認
- `DATABASE_URL` の形式が正しいか確認
- RDSエンドポイントが正しいか確認

### 6.2 ALBヘルスチェックが失敗する

**確認方法:**
1. 「**EC2**」→「**ターゲットグループ**」→`prooflink-tg`
2. 「**ターゲット**」タブでステータスを確認

**解決策:**
- ヘルスチェックパス `/api/health` が正しく実装されているか確認
- ECSタスクのポート3000が正しく開いているか確認
- セキュリティグループでALBからECSへの通信が許可されているか確認

### 6.3 パブリックIPでインターネットにアクセスできない

**確認方法:**
ECSタスクのログで外部APIへの接続エラーを確認

**解決策:**
1. パブリックサブネットのルートテーブルを確認
2. `0.0.0.0/0` → インターネットゲートウェイのルートが存在するか確認
3. ECSセキュリティグループのアウトバウンドルールで `0.0.0.0/0` が許可されているか確認

### 6.4 コストが予想より高い

**確認方法:**
1. 「**コストエクスプローラー**」で最もコストがかかっているサービスを特定
2. 「**Cost and Usage Reports**」で詳細を確認

**よくある原因:**
- NATゲートウェイが作成されている → 削除
- ECSタスクが複数起動している → サービスの希望タスク数を1に設定
- RDSがMulti-AZになっている → 開発環境ではSingle-AZに変更
- データ転送量が多い → CloudFront導入を検討

### 6.5 AWS Batchジョブが起動しない

**確認方法:**
1. 「**AWS Batch**」→「**ジョブ**」で該当ジョブを選択
2. ステータスとログを確認

**よくある原因と解決策:**

#### ジョブがRUNNABLE状態で停止

**原因:** コンピューティング環境のリソース不足

**解決策:**
- コンピューティング環境の最大vCPUを増やす
- 他のジョブが完了するまで待つ

#### ジョブがFAILED状態

**エラー例:**
```
CannotPullContainerError: pull image manifest has been retried
```

**解決策:**
- ECRにバッチイメージが存在するか確認
- `prooflink-batch-execution-role` に `AmazonECSTaskExecutionRolePolicy` がアタッチされているか確認
- イメージURIが正しいか確認

#### データベース接続エラー

**エラー例:**
```
Error: connect ETIMEDOUT
```

**解決策:**
- RDSセキュリティグループに `prooflink-batch-sg` からのポート5432が許可されているか確認
- `DATABASE_URL` 環境変数が正しいか確認
- バッチジョブがパブリックサブネット+パブリックIP付きで実行されているか確認

#### S3アクセスエラー

**エラー例:**
```
AccessDenied: Access Denied
```

**解決策:**
- `prooflink-batch-task-role` に適切なS3アクセス権限があるか確認
- S3バケット名が正しいか確認
- ジョブ定義でタスクロールが設定されているか確認

### 6.6 AWS Batchジョブのログが見れない

**確認方法:**
1. ジョブの詳細画面で「ログストリーム名」のリンクを確認
2. リンクが無効な場合はログ設定に問題あり

**解決策:**
- CloudWatch Logsグループ `/aws/batch/prooflink-dev` が作成されているか確認
- ジョブ定義のログ設定が正しいか確認
- `prooflink-batch-execution-role` にCloudWatch Logs書き込み権限があるか確認

---

## 次のステップ

環境構築が完了したら、以下のドキュメントを参照してください:

- **アプリケーションのデプロイ**: `CI_CD_SETUP.md`
- **ローカル開発環境**: `LOCAL_DEVELOPMENT_S3_SETUP.md`
- **クイックスタート**: `QUICKSTART.md`

---

**作成日**: 2026-01-23
**最終更新**: 2026-01-23
**対象環境**: 開発・本番共通
