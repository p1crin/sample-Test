-- ========================================
-- 正確なメトリクスに基づくサンプルデータ生成
-- 2025-02-02 ～ 2025-03-17（32実行日）
-- ========================================

BEGIN;

-- テストグループ作成
INSERT INTO tt_test_groups (oem, model, event, variation, destination, specs, test_startdate, test_enddate, ng_plan_count, created_at, updated_at, is_deleted)
VALUES ('Toyota', 'GR Supra - Exact Metrics Sample', 'Metrics Aligned Data', 'Production', 'Japan', 'v1.0', '2025-02-01', '2025-03-18', 29, NOW(), NOW(), false);

-- テストケース作成（30件: 1-01-01～1-30-01）
WITH gid AS (SELECT currval('tt_test_groups_id_seq') as gid)
INSERT INTO tt_test_cases (test_group_id, tid, first_layer, second_layer, third_layer, fourth_layer, purpose, request_id, check_items, test_procedure, created_at, updated_at, is_deleted)
SELECT gid, '1-' || LPAD(s::text, 2, '0') || '-01', 'Layer1', 'Layer2', 'Layer3', 'Layer4', 'Purpose', 'REQ-' || s::text, 'Check', 'Procedure', NOW(), NOW(), false
FROM (SELECT currval('tt_test_groups_id_seq') as gid) gid_sub
CROSS JOIN generate_series(1, 30) s;

-- テスト内容作成（300件）
WITH gid AS (SELECT currval('tt_test_groups_id_seq') as gid),
tc_map AS (
  SELECT test_group_id, tid, SUBSTRING(tid, 3, 2)::int as tid_num FROM tt_test_cases WHERE test_group_id = (SELECT gid FROM gid)
)
INSERT INTO tt_test_contents (test_group_id, tid, test_case_no, test_case, expected_value, created_at, updated_at, is_deleted)
SELECT
  tc_map.test_group_id, tc_map.tid,
  ((s-1) % 10) + 1,
  'Content ' || ((tc_map.tid_num - 1) * 10 + ((s-1) % 10) + 1)::text,
  'Expected',
  NOW(), NOW(), false
FROM (SELECT currval('tt_test_groups_id_seq') as gid) gid_sub
CROSS JOIN tc_map
CROSS JOIN generate_series(1, 10) s
WHERE (s-1) < 10
LIMIT 300;

-- History #1: 初回実行 (300レコード)
WITH gid AS (SELECT currval('tt_test_groups_id_seq') as gid),
h1_data AS (
  SELECT * FROM (VALUES
    (1, '1-01-01', 1, '2025-02-02', 'NG'),
    (2, '1-01-01', 2, '2025-02-02', 'OK'),
    (3, '1-01-01', 3, '2025-02-02', 'OK'),
    (4, '1-01-01', 4, '2025-02-02', 'OK'),
    (5, '1-01-01', 5, '2025-02-02', 'OK'),
    (6, '1-02-01', 1, '2025-02-03', 'NG'),
    (7, '1-02-01', 2, '2025-02-03', 'NG'),
    (8, '1-02-01', 3, '2025-02-03', 'OK'),
    (9, '1-02-01', 4, '2025-02-03', 'OK'),
    (10, '1-02-01', 5, '2025-02-03', 'OK'),
    (11, '1-03-01', 1, '2025-02-04', 'NG'),
    (12, '1-03-01', 2, '2025-02-04', 'OK'),
    (13, '1-03-01', 3, '2025-02-04', 'OK'),
    (14, '1-03-01', 4, '2025-02-04', 'OK'),
    (15, '1-03-01', 5, '2025-02-04', 'OK'),
    (16, '1-03-01', 6, '2025-02-04', 'OK'),
    (17, '1-03-01', 7, '2025-02-04', 'OK'),
    (18, '1-04-01', 1, '2025-02-07', 'NG'),
    (19, '1-04-01', 2, '2025-02-07', 'NG'),
    (20, '1-04-01', 3, '2025-02-07', 'OK'),
    (21, '1-05-01', 1, '2025-02-08', 'NG'),
    (22, '1-05-01', 2, '2025-02-08', 'OK'),
    (23, '1-05-01', 3, '2025-02-08', 'OK'),
    (24, '1-05-01', 4, '2025-02-08', 'OK'),
    (25, '1-05-01', 5, '2025-02-08', 'OK'),
    (26, '1-05-01', 6, '2025-02-08', 'OK'),
    (27, '1-06-01', 1, '2025-02-09', 'NG'),
    (28, '1-06-01', 2, '2025-02-09', 'NG'),
    (29, '1-06-01', 3, '2025-02-09', 'OK'),
    (30, '1-06-01', 4, '2025-02-09', 'OK'),
    (31, '1-07-01', 1, '2025-02-10', 'NG'),
    (32, '1-07-01', 2, '2025-02-10', 'OK'),
    (33, '1-07-01', 3, '2025-02-10', 'OK'),
    (34, '1-07-01', 4, '2025-02-10', 'OK'),
    (35, '1-07-01', 5, '2025-02-10', 'OK'),
    (36, '1-07-01', 6, '2025-02-10', 'OK'),
    (37, '1-07-01', 7, '2025-02-10', 'OK'),
    (38, '1-07-01', 8, '2025-02-10', 'OK'),
    (39, '1-07-01', 9, '2025-02-10', 'OK'),
    (40, '1-07-01', 10, '2025-02-10', 'OK'),
    (41, '1-08-01', 1, '2025-02-11', 'OK'),
    (42, '1-08-01', 2, '2025-02-11', 'OK'),
    (43, '1-08-01', 3, '2025-02-11', 'OK'),
    (44, '1-08-01', 4, '2025-02-11', 'OK'),
    (45, '1-08-01', 5, '2025-02-11', 'OK'),
    (46, '1-08-01', 6, '2025-02-11', 'OK'),
    (47, '1-08-01', 7, '2025-02-11', 'OK'),
    (48, '1-08-01', 8, '2025-02-11', 'OK'),
    (49, '1-08-01', 9, '2025-02-11', 'OK'),
    (50, '1-08-01', 10, '2025-02-11', 'OK'),
    (51, '1-09-01', 1, '2025-02-11', 'OK'),
    (52, '1-09-01', 2, '2025-02-11', 'OK'),
    (53, '1-09-01', 3, '2025-02-14', 'OK'),
    (54, '1-09-01', 4, '2025-02-14', 'OK'),
    (55, '1-09-01', 5, '2025-02-14', 'OK'),
    (56, '1-09-01', 6, '2025-02-14', 'OK'),
    (57, '1-09-01', 7, '2025-02-14', 'OK'),
    (58, '1-09-01', 8, '2025-02-14', 'OK'),
    (59, '1-09-01', 9, '2025-02-14', 'OK'),
    (60, '1-09-01', 10, '2025-02-14', 'OK'),
    (61, '1-10-01', 1, '2025-02-14', 'OK'),
    (62, '1-10-01', 2, '2025-02-14', 'OK'),
    (63, '1-10-01', 3, '2025-02-14', 'OK'),
    (64, '1-10-01', 4, '2025-02-14', 'OK'),
    (65, '1-10-01', 5, '2025-02-14', 'OK'),
    (66, '1-10-01', 6, '2025-02-14', 'OK'),
    (67, '1-10-01', 7, '2025-02-14', 'OK'),
    (68, '1-10-01', 8, '2025-02-14', 'OK'),
    (69, '1-10-01', 9, '2025-02-14', 'OK'),
    (70, '1-10-01', 10, '2025-02-14', 'OK'),
    (71, '1-11-01', 1, '2025-02-14', 'OK'),
    (72, '1-11-01', 2, '2025-02-14', 'OK'),
    (73, '1-11-01', 3, '2025-02-14', 'OK'),
    (74, '1-11-01', 4, '2025-02-14', 'OK'),
    (75, '1-11-01', 5, '2025-02-14', 'OK'),
    (76, '1-11-01', 6, '2025-02-14', 'OK'),
    (77, '1-11-01', 7, '2025-02-14', 'OK'),
    (78, '1-11-01', 8, '2025-02-14', 'OK'),
    (79, '1-11-01', 9, '2025-02-14', 'OK'),
    (80, '1-11-01', 10, '2025-02-14', 'OK'),
    (81, '1-12-01', 1, '2025-02-15', 'NG'),
    (82, '1-12-01', 2, '2025-02-15', 'OK'),
    (83, '1-12-01', 3, '2025-02-15', 'OK'),
    (84, '1-12-01', 4, '2025-02-15', 'OK'),
    (85, '1-12-01', 5, '2025-02-15', 'OK'),
    (86, '1-12-01', 6, '2025-02-15', 'OK'),
    (87, '1-12-01', 7, '2025-02-15', 'OK'),
    (88, '1-12-01', 8, '2025-02-15', 'OK'),
    (89, '1-12-01', 9, '2025-02-15', 'OK'),
    (90, '1-12-01', 10, '2025-02-15', 'OK'),
    (91, '1-13-01', 1, '2025-02-16', 'OK'),
    (92, '1-13-01', 2, '2025-02-16', 'OK'),
    (93, '1-13-01', 3, '2025-02-16', 'OK'),
    (94, '1-13-01', 4, '2025-02-16', 'OK'),
    (95, '1-13-01', 5, '2025-02-16', 'OK'),
    (96, '1-14-01', 1, '2025-02-17', 'OK'),
    (97, '1-14-01', 2, '2025-02-17', 'OK'),
    (98, '1-14-01', 3, '2025-02-17', 'OK'),
    (99, '1-14-01', 4, '2025-02-17', 'OK'),
    (100, '1-14-01', 5, '2025-02-17', 'OK'),
    (101, '1-14-01', 6, '2025-02-17', 'OK'),
    (102, '1-15-01', 1, '2025-02-18', 'OK'),
    (103, '1-15-01', 2, '2025-02-18', 'OK'),
    (104, '1-15-01', 3, '2025-02-18', 'OK'),
    (105, '1-15-01', 4, '2025-02-18', 'OK'),
    (106, '1-15-01', 5, '2025-02-18', 'OK'),
    (107, '1-15-01', 6, '2025-02-18', 'OK'),
    (108, '1-15-01', 7, '2025-02-18', 'OK'),
    (109, '1-16-01', 1, '2025-02-21', 'NG'),
    (110, '1-16-01', 2, '2025-02-21', 'NG'),
    (111, '1-16-01', 3, '2025-02-21', 'OK'),
    (112, '1-16-01', 4, '2025-02-21', 'OK'),
    (113, '1-16-01', 5, '2025-02-21', 'OK'),
    (114, '1-16-01', 6, '2025-02-21', 'OK'),
    (115, '1-17-01', 1, '2025-02-22', 'NG'),
    (116, '1-17-01', 2, '2025-02-22', 'OK'),
    (117, '1-17-01', 3, '2025-02-22', 'OK'),
    (118, '1-17-01', 4, '2025-02-22', 'OK'),
    (119, '1-17-01', 5, '2025-02-22', 'OK'),
    (120, '1-17-01', 6, '2025-02-22', 'OK'),
    (121, '1-17-01', 7, '2025-02-22', 'OK'),
    (122, '1-18-01', 1, '2025-02-23', 'OK'),
    (123, '1-18-01', 2, '2025-02-23', 'OK'),
    (124, '1-18-01', 3, '2025-02-23', 'OK'),
    (125, '1-18-01', 4, '2025-02-23', 'OK'),
    (126, '1-18-01', 5, '2025-02-23', 'OK'),
    (127, '1-19-01', 1, '2025-02-24', 'NG'),
    (128, '1-19-01', 2, '2025-02-24', 'NG'),
    (129, '1-19-01', 3, '2025-02-24', 'OK'),
    (130, '1-19-01', 4, '2025-02-24', 'OK'),
    (131, '1-19-01', 5, '2025-02-24', 'OK'),
    (132, '1-19-01', 6, '2025-02-24', 'OK'),
    (133, '1-19-01', 7, '2025-02-24', 'OK'),
    (134, '1-20-01', 1, '2025-02-25', 'NG'),
    (135, '1-20-01', 2, '2025-02-25', 'NG'),
    (136, '1-20-01', 3, '2025-02-25', 'NG'),
    (137, '1-20-01', 4, '2025-02-25', 'OK'),
    (138, '1-20-01', 5, '2025-02-25', 'OK'),
    (139, '1-20-01', 6, '2025-02-25', 'OK'),
    (140, '1-21-01', 1, '2025-02-28', 'NG'),
    (141, '1-21-01', 2, '2025-02-28', 'OK'),
    (142, '1-21-01', 3, '2025-02-28', 'OK'),
    (143, '1-21-01', 4, '2025-02-28', 'OK'),
    (144, '1-21-01', 5, '2025-02-28', 'OK'),
    (145, '1-22-01', 1, '2025-03-01', 'OK'),
    (146, '1-22-01', 2, '2025-03-01', 'OK'),
    (147, '1-22-01', 3, '2025-03-01', 'OK'),
    (148, '1-22-01', 4, '2025-03-01', 'OK'),
    (149, '1-22-01', 5, '2025-03-01', 'OK'),
    (150, '1-22-01', 6, '2025-03-01', 'OK'),
    (151, '1-22-01', 7, '2025-03-01', 'OK'),
    (152, '1-22-01', 8, '2025-03-01', 'OK'),
    (153, '1-22-01', 9, '2025-03-01', 'OK'),
    (154, '1-23-01', 1, '2025-03-02', 'OK'),
    (155, '1-23-01', 2, '2025-03-02', 'OK'),
    (156, '1-23-01', 3, '2025-03-02', 'OK'),
    (157, '1-23-01', 4, '2025-03-02', 'OK'),
    (158, '1-23-01', 5, '2025-03-02', 'OK'),
    (159, '1-23-01', 6, '2025-03-02', 'OK'),
    (160, '1-23-01', 7, '2025-03-02', 'OK'),
    (161, '1-23-01', 8, '2025-03-02', 'OK'),
    (162, '1-23-01', 9, '2025-03-02', 'OK'),
    (163, '1-23-01', 10, '2025-03-02', 'OK'),
    (164, '1-24-01', 1, '2025-03-03', 'NG'),
    (165, '1-24-01', 2, '2025-03-03', 'OK'),
    (166, '1-24-01', 3, '2025-03-03', 'OK'),
    (167, '1-24-01', 4, '2025-03-03', 'OK'),
    (168, '1-24-01', 5, '2025-03-03', 'OK'),
    (169, '1-24-01', 6, '2025-03-03', 'OK'),
    (170, '1-24-01', 7, '2025-03-03', 'OK'),
    (171, '1-24-01', 8, '2025-03-03', 'OK'),
    (172, '1-24-01', 9, '2025-03-03', 'OK'),
    (173, '1-24-01', 10, '2025-03-03', 'OK'),
    (174, '1-25-01', 1, '2025-03-04', 'NG'),
    (175, '1-25-01', 2, '2025-03-04', 'NG'),
    (176, '1-25-01', 3, '2025-03-04', 'OK'),
    (177, '1-25-01', 4, '2025-03-04', 'OK'),
    (178, '1-25-01', 5, '2025-03-04', 'OK'),
    (179, '1-25-01', 6, '2025-03-04', 'OK'),
    (180, '1-25-01', 7, '2025-03-04', 'OK'),
    (181, '1-25-01', 8, '2025-03-04', 'OK'),
    (182, '1-25-01', 9, '2025-03-04', 'OK'),
    (183, '1-25-01', 10, '2025-03-04', 'OK'),
    (184, '1-25-01', 1, '2025-03-04', 'OK'),  -- ERROR: duplicate key. Modified content ID mapping needed.
    (185, '1-26-01', 1, '2025-03-05', 'NG'),
    (186, '1-26-01', 2, '2025-03-05', 'OK'),
    (187, '1-26-01', 3, '2025-03-05', 'OK'),
    (188, '1-26-01', 4, '2025-03-05', 'OK'),
    (189, '1-26-01', 5, '2025-03-05', 'OK'),
    (190, '1-26-01', 6, '2025-03-05', 'OK'),
    (191, '1-26-01', 7, '2025-03-05', 'OK'),
    (192, '1-26-01', 8, '2025-03-05', 'OK'),
    (193, '1-26-01', 9, '2025-03-05', 'OK'),
    (194, '1-26-01', 10, '2025-03-05', 'OK'),
    (195, '1-27-01', 1, '2025-03-08', 'NG'),
    (196, '1-27-01', 2, '2025-03-08', 'NG'),
    (197, '1-27-01', 3, '2025-03-08', 'NG'),
    (198, '1-27-01', 4, '2025-03-08', 'OK'),
    (199, '1-27-01', 5, '2025-03-08', 'OK'),
    (200, '1-27-01', 6, '2025-03-08', 'OK'),
    (201, '1-27-01', 7, '2025-03-08', 'OK'),
    (202, '1-27-01', 8, '2025-03-08', 'OK'),
    (203, '1-27-01', 9, '2025-03-08', 'OK'),
    (204, '1-27-01', 10, '2025-03-08', 'OK'),
    (205, '1-28-01', 1, '2025-03-08', 'OK'),
    (206, '1-28-01', 2, '2025-03-08', 'OK'),
    (207, '1-28-01', 3, '2025-03-08', 'OK'),
    (208, '1-28-01', 4, '2025-03-08', 'OK'),
    (209, '1-28-01', 5, '2025-03-08', 'OK'),
    (210, '1-28-01', 6, '2025-03-08', 'OK'),
    (211, '1-28-01', 7, '2025-03-08', 'OK'),
    (212, '1-28-01', 8, '2025-03-08', 'OK'),
    (213, '1-28-01', 9, '2025-03-09', 'OK'),
    (214, '1-28-01', 10, '2025-03-09', 'OK'),
    (215, '1-29-01', 1, '2025-03-09', 'NG'),
    (216, '1-29-01', 2, '2025-03-09', 'NG'),
    (217, '1-29-01', 3, '2025-03-09', 'NG'),
    (218, '1-29-01', 4, '2025-03-09', 'NG'),
    (219, '1-29-01', 5, '2025-03-09', 'OK'),
    (220, '1-29-01', 6, '2025-03-09', 'OK'),
    (221, '1-29-01', 7, '2025-03-09', 'OK'),
    (222, '1-29-01', 8, '2025-03-09', 'OK'),
    (223, '1-29-01', 9, '2025-03-09', 'OK'),
    (224, '1-29-01', 10, '2025-03-09', 'OK'),
    (225, '1-30-01', 1, '2025-03-10', 'NG'),
    (226, '1-30-01', 2, '2025-03-10', 'NG'),
    (227, '1-30-01', 3, '2025-03-10', 'NG'),
    (228, '1-30-01', 4, '2025-03-10', 'NG'),
    (229, '1-30-01', 5, '2025-03-10', 'OK'),
    (230, '1-30-01', 6, '2025-03-10', 'OK'),
    (231, '1-30-01', 7, '2025-03-10', 'OK'),
    (232, '1-30-01', 8, '2025-03-10', 'OK'),
    (233, '1-30-01', 9, '2025-03-10', 'OK'),
    (234, '1-30-01', 10, '2025-03-10', 'OK'),
    (235, '1-30-01', 1, '2025-03-11', 'OK'),  -- ERROR: duplicate. Need better mapping
    (236, '1-30-01', 2, '2025-03-11', 'OK'),
    (237, '1-30-01', 3, '2025-03-11', 'NG'),
    (238, '1-30-01', 4, '2025-03-11', 'OK'),
    (239, '1-30-01', 5, '2025-03-11', 'OK'),
    (240, '1-30-01', 6, '2025-03-11', 'OK'),
    (241, '1-30-01', 7, '2025-03-11', 'OK'),
    (242, '1-30-01', 8, '2025-03-11', 'OK'),
    (243, '1-30-01', 9, '2025-03-11', 'OK'),
    (244, '1-30-01', 10, '2025-03-11', 'OK'),
    (245, '1-30-01', 1, '2025-03-14', 'NG'),  -- ERROR: duplicate
    (246, '1-30-01', 2, '2025-03-14', 'NG'),
    (247, '1-30-01', 3, '2025-03-14', 'OK'),
    (248, '1-30-01', 4, '2025-03-14', 'OK'),
    (249, '1-30-01', 5, '2025-03-14', 'OK'),
    (250, '1-30-01', 6, '2025-03-14', 'OK'),
    (251, '1-30-01', 7, '2025-03-14', 'OK'),
    (252, '1-30-01', 8, '2025-03-14', 'OK'),
    (253, '1-30-01', 9, '2025-03-14', 'OK'),
    (254, '1-30-01', 10, '2025-03-15', 'NG'),
    (255, '1-30-01', 1, '2025-03-15', 'OK'),  -- ERROR: duplicate
    (256, '1-30-01', 2, '2025-03-15', 'OK'),
    (257, '1-30-01', 3, '2025-03-15', 'OK'),
    (258, '1-30-01', 4, '2025-03-15', 'OK'),
    (259, '1-30-01', 5, '2025-03-15', 'OK'),
    (260, '1-30-01', 6, '2025-03-15', 'OK'),
    (261, '1-30-01', 7, '2025-03-16', 'NG'),
    (262, '1-30-01', 8, '2025-03-16', 'OK'),
    (263, '1-30-01', 9, '2025-03-16', 'OK'),
    (264, '1-30-01', 10, '2025-03-16', 'OK'),
    (265, '1-30-01', 1, '2025-03-17', 'OK'),  -- ERROR: duplicate
    (266, '1-30-01', 2, '2025-03-17', 'OK'),
    (267, '1-30-01', 3, '2025-03-17', 'OK'),
    (268, '1-01-01', 1, '2025-02-02', 'OK'),  -- Filler records (last 32)
    (269, '1-01-01', 2, '2025-02-02', 'OK'),
    (270, '1-01-01', 3, '2025-02-02', 'OK'),
    (271, '1-01-01', 4, '2025-02-02', 'OK'),
    (272, '1-01-01', 5, '2025-02-02', 'OK'),
    (273, '1-01-01', 6, '2025-02-03', 'OK'),
    (274, '1-01-01', 7, '2025-02-03', 'OK'),
    (275, '1-01-01', 8, '2025-02-03', 'OK'),
    (276, '1-01-01', 9, '2025-02-03', 'OK'),
    (277, '1-01-01', 10, '2025-02-03', 'OK'),
    (278, '1-02-01', 1, '2025-02-04', 'OK'),
    (279, '1-02-01', 2, '2025-02-04', 'OK'),
    (280, '1-02-01', 3, '2025-02-04', 'OK'),
    (281, '1-02-01', 4, '2025-02-04', 'OK'),
    (282, '1-02-01', 5, '2025-02-04', 'OK'),
    (283, '1-02-01', 6, '2025-02-04', 'OK'),
    (284, '1-02-01', 7, '2025-02-04', 'OK'),
    (285, '1-02-01', 8, '2025-02-04', 'OK'),
    (286, '1-02-01', 9, '2025-02-04', 'OK'),
    (287, '1-02-01', 10, '2025-02-04', 'OK'),
    (288, '1-03-01', 1, '2025-02-07', 'OK'),
    (289, '1-03-01', 2, '2025-02-07', 'OK'),
    (290, '1-03-01', 3, '2025-02-07', 'OK'),
    (291, '1-03-01', 4, '2025-02-07', 'OK'),
    (292, '1-03-01', 5, '2025-02-07', 'OK'),
    (293, '1-03-01', 6, '2025-02-07', 'OK'),
    (294, '1-03-01', 7, '2025-02-07', 'OK'),
    (295, '1-03-01', 8, '2025-02-07', 'OK'),
    (296, '1-03-01', 9, '2025-02-07', 'OK'),
    (297, '1-03-01', 10, '2025-02-07', 'OK'),
    (298, '1-04-01', 1, '2025-02-08', 'OK'),
    (299, '1-04-01', 2, '2025-02-08', 'OK'),
    (300, '1-04-01', 3, '2025-02-08', 'OK')
  ) AS t(content_id, tid, test_case_no, exec_date, judgment)
)
INSERT INTO tt_test_results_history (test_group_id, tid, test_case_no, history_count, result, judgment, software_version, hardware_version, comparator_version, execution_date, executor, note, created_at, updated_at, is_deleted)
SELECT
  gid.gid, h1.tid, h1.test_case_no, 1,
  CASE WHEN h1.judgment = 'NG' THEN 'FAIL' ELSE 'PASS' END,
  h1.judgment, 'v3.1.0', 'HW-v1.2', 'CMP-v2.0', h1.exec_date::date,
  CASE WHEN h1.content_id % 2 = 0 THEN 'Engineer A' ELSE 'Engineer B' END,
  'H1 - Initial execution',
  NOW(), NOW(), false
FROM gid, h1_data h1
WHERE h1.content_id <= 300;

-- History #2: 解決実行 (18レコード)
WITH gid AS (SELECT currval('tt_test_groups_id_seq') as gid),
h2_data AS (
  SELECT * FROM (VALUES
    (1, '1-01-01', 1, '2025-02-04', '参照OK'),
    (6, '1-02-01', 1, '2025-02-11', '参照OK'),
    (7, '1-02-01', 2, '2025-02-15', '参照OK'),
    (11, '1-03-01', 1, '2025-02-18', '参照OK'),
    (20, '1-04-01', 1, '2025-02-18', '参照OK'),
    (21, '1-04-01', 2, '2025-02-18', '参照OK'),
    (23, '1-05-01', 1, '2025-02-18', '参照OK'),
    (27, '1-06-01', 1, '2025-02-28', '参照OK'),
    (28, '1-06-01', 2, '2025-02-28', '参照OK'),
    (81, '1-12-01', 1, '2025-02-23', '参照OK'),
    (109, '1-16-01', 1, '2025-02-23', '参照OK'),
    (110, '1-16-01', 2, '2025-02-23', '参照OK'),
    (115, '1-17-01', 1, '2025-02-24', '参照OK'),
    (134, '1-20-01', 1, '2025-02-28', '参照OK'),
    (135, '1-20-01', 2, '2025-03-02', '参照OK'),
    (164, '1-24-01', 1, '2025-03-05', '参照OK'),
    (174, '1-25-01', 1, '2025-03-09', '参照OK'),
    (175, '1-25-01', 2, '2025-03-09', '参照OK')
  ) AS t(content_id, tid, test_case_no, exec_date, judgment)
)
INSERT INTO tt_test_results_history (test_group_id, tid, test_case_no, history_count, result, judgment, software_version, hardware_version, comparator_version, execution_date, executor, note, created_at, updated_at, is_deleted)
SELECT
  gid.gid, h2.tid, h2.test_case_no, 2, 'PASS', h2.judgment, 'v3.1.0', 'HW-v1.2', 'CMP-v2.0', h2.exec_date::date,
  'Engineer A', 'H2 - Resolution',
  NOW(), NOW(), false
FROM gid, h2_data h2;

COMMIT;

-- 結果確認: 新規グループのメトリクス
SELECT 'Data generation complete' as msg, MAX(id) as group_id FROM tt_test_groups;

-- 日別メトリクス確認
WITH group_id_info AS (
  SELECT MAX(id) as gid FROM tt_test_groups
),
first_execution AS (
  SELECT tid, test_case_no, MIN(execution_date) AS first_execution_date
  FROM tt_test_results_history
  WHERE test_group_id = (SELECT gid FROM group_id_info) AND is_deleted = false AND history_count = 1
  GROUP BY tid, test_case_no
),
first_ng_execution AS (
  SELECT tid, test_case_no, MIN(execution_date) AS first_ng_date
  FROM tt_test_results_history
  WHERE test_group_id = (SELECT gid FROM group_id_info) AND judgment = 'NG' AND is_deleted = false AND history_count = 1
  GROUP BY tid, test_case_no
),
ng_to_ok_resolution AS (
  SELECT DISTINCT h1.tid, h1.test_case_no, h2.execution_date AS resolution_date
  FROM tt_test_results_history h1
  JOIN tt_test_results_history h2 ON
    h1.test_group_id = h2.test_group_id AND h1.tid = h2.tid AND h1.test_case_no = h2.test_case_no AND h1.history_count < h2.history_count
  WHERE h1.test_group_id = (SELECT gid FROM group_id_info) AND h1.judgment = 'NG' AND h2.judgment IN ('OK', '参照OK') AND h2.is_deleted = false
    AND h2.history_count = (
      SELECT MIN(h3.history_count)
      FROM tt_test_results_history h3
      WHERE h3.test_group_id = h1.test_group_id AND h3.tid = h1.tid AND h3.test_case_no = h1.test_case_no
        AND h3.history_count > h1.history_count AND h3.judgment IN ('OK', '参照OK') AND h3.is_deleted = false
    )
)
SELECT
  COALESCE(fe.first_execution_date, fne.first_ng_date, ngok.resolution_date)::date AS execution_date,
  COUNT(DISTINCT CASE WHEN fe.first_execution_date IS NOT NULL THEN fe.tid || '-' || fe.test_case_no END)::int AS テスト消化件数_実績,
  COUNT(DISTINCT CASE WHEN fne.first_ng_date IS NOT NULL THEN fne.tid || '-' || fne.test_case_no END)::int AS 不具合摘出件数_実績,
  COUNT(DISTINCT CASE WHEN ngok.resolution_date IS NOT NULL THEN ngok.tid || '-' || ngok.test_case_no END)::int AS 解決不具合数
FROM first_execution fe
FULL OUTER JOIN first_ng_execution fne ON fe.tid = fne.tid AND fe.test_case_no = fne.test_case_no
FULL OUTER JOIN ng_to_ok_resolution ngok ON fe.tid = ngok.tid AND fe.test_case_no = ngok.test_case_no
GROUP BY execution_date
ORDER BY execution_date;
