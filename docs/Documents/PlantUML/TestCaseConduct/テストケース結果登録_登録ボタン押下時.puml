@startuml テスト結果登録
title 登録ボタン押下時シーケンス図

actor ログインユーザー as User
participant "テスト結果登録画面" as Screen
participant "S3署名付きURL発行API" as S3API
participant "AWS S3" as S3
participant "テスト結果登録API" as ResultAPI
participant "AWS RDS" as DB

== エビデンスファイルアップロード ==
User -> Screen: エビデンスファイル選択
Screen -> S3API: S3署名付きURL発行APIをリクエスト
note right  S3API
  Authorization: Bearer{JWT}
end note

ref over S3API
  ミドルウェアで権限チェック(許可された権限[システム管理者、テスト管理者、一般])
end ref

alt 権限チェック成功
  note right of S3API
    temp/ フォルダに一時保存
    24時間後に自動削除
  end note
  S3API -> S3API: JWT検証 + 署名付きURL生成
  S3API --> Screen: { presignedUrl, tempS3Key }
  Screen -> S3: ファイルをアップロード
  S3 -> S3: temp/evidence/ にファイル保存
  note right of S3
    例: temp/evidence/1234567890-screenshot.png
  end note
  S3 --> Screen: 200 OK
  Screen -> Screen: tempS3Keyを配列に追加
  Screen --> User: ファイルアップロード完了
else トークン無し
  S3API --> Screen: 401 Unauthorized
  Screen -> Screen: 保存された情報を削除
  Screen --> User: ログイン画面へリダイレクト。
else 権限チェック失敗
  S3API --> Screen: 403 Forbidden
  Screen --> User: 権限エラーを表示。
else リクエストパラメータ不正
  S3API --> Screen: 400 Bad Request
  Screen --> User: パラメータエラーを表示。
end

== テスト結果登録 + 本番フォルダへコピー ==
User -> Screen: 「登録」ボタンクリック

Screen -> ResultAPI: テスト結果登録APIをリクエスト

note right ResultAPI
  Authorization: Bearer{JWT}
end note

ref over ResultAPI
  ミドルウェアで権限チェック(許可された権限[システム管理者、テスト管理者、一般])
end ref

alt 権限チェック成功
    ResultAPI -> DB: 入力されたテスト結果情報を登録/更新
  note right of DB
  INSERT INTO tt_test_results
  (
      test_group_id,
      tid,
      test_case_no,
      result,
      judgment,
      software_version,
      hardware_version,
      comparator_version,
      execution_date,
      executor,
      note,
      version,
      created_at,
      updated_at,
      is_deleted
  )
  VALUES
  (
      リクエストパラメータのtest_group_id,
      リクエストパラメータのtid,
      リクエストパラメータのtest_case_no,
      リクエストパラメータのresult,
      リクエストパラメータのjudgment,
      リクエストパラメータのsoftware_version,
      リクエストパラメータのhardware_version,
      リクエストパラメータのcomparator_version,
      リクエストパラメータのexecution_date,
      リクエストパラメータのexecutor,
      リクエストパラメータのnote,
      1,
      CURRENT_TIMESTAMP,
      CURRENT_TIMESTAMP,
      false
  )
  ON CONFLICT (test_group_id, tid, test_case_no)
  DO UPDATE SET
      result = EXCLUDED.result,
      judgment = EXCLUDED.judgment,
      software_version = EXCLUDED.software_version,
      hardware_version = EXCLUDED.hardware_version,
      comparator_version = EXCLUDED.comparator_version,
      execution_date = EXCLUDED.execution_date,
      executor = EXCLUDED.executor,
      note = EXCLUDED.note,
      version = EXCLUDED.version + 1,
      updated_at = CURRENT_TIMESTAMP,
      is_deleted = EXCLUDED.is_deleted;
  end note
  note right of DB
  INSERT INTO tt_test_results_history
  (
      test_group_id,
      tid,
      test_case_no,
      history_count,
      result,
      judgment,
      software_version,
      hardware_version,
      comparator_version,
      execution_date,
      executor,
      note,
      version,
      created_at,
      updated_at,
      is_deleted
  )
  VALUES
  (
      リクエストパラメータのtest_group_id,
      リクエストパラメータのtid,
      リクエストパラメータのtest_case_no,
      1,
      リクエストパラメータのresult,
      リクエストパラメータのjudgment,
      リクエストパラメータのsoftware_version,
      リクエストパラメータのhardware_version,
      リクエストパラメータのcomparator_version,
      リクエストパラメータのexecution_date,
      リクエストパラメータのexecutor,
      リクエストパラメータのnote,
      1,
      CURRENT_TIMESTAMP,
      CURRENT_TIMESTAMP,
      false
  )
  ON CONFLICT (test_group_id, tid, test_case_no, history_count)
  DO UPDATE SET
      result = EXCLUDED.result,
      judgment = EXCLUDED.judgment,
      software_version = EXCLUDED.software_version,
      hardware_version = EXCLUDED.hardware_version,
      comparator_version = EXCLUDED.comparator_version,
      execution_date = EXCLUDED.execution_date,
      executor = EXCLUDED.executor,
      note = EXCLUDED.note,
      version = EXCLUDED.version + 1,
      updated_at = CURRENT_TIMESTAMP,
      is_deleted = EXCLUDED.is_deleted;
  end note

  loop temp_evidence_filesの各tempS3Key
      ResultAPI -> S3: temp/ から evidence/ にコピー
      S3 --> ResultAPI: コピー完了

      ResultAPI -> DB: 入力されたエビデンス情報を登録/更新
      note right of DB
      INSERT INTO tt_test_evidences
      (
          test_group_id,
          tid,
          test_case_no,
          history_count,
          evidence_no,
          evidence_name,
          evidence_path,
          created_at,
          updated_at,
          is_deleted
      )
      VALUES
      (
          リクエストパラメータのtest_group_id,
          リクエストパラメータのtid,
          リクエストパラメータのtest_case_no,
          リクエストパラメータのhistory_count,
          リクエストパラメータのevidence_no,
          リクエストパラメータのevidence_name,
          本番S3パス,
          CURRENT_TIMESTAMP,
          CURRENT_TIMESTAMP,
          false
      )
      ON CONFLICT (test_group_id, tid, test_case_no, history_count, evidence_no)
      DO UPDATE SET
          evidence_name = EXCLUDED.evidence_name,
          evidence_path = EXCLUDED.evidence_path,
          updated_at = CURRENT_TIMESTAMP,
          is_deleted = EXCLUDED.is_deleted;
      end note
  end
  alt 登録成功
    DB --> ResultAPI: 登録件数を返却。
    ResultAPI --> Screen: 201 Created
    Screen --> User: テストケース結果確認画面へ遷移表示
  else 登録失敗
    DB --> ResultAPI: エラーを返却。
    ResultAPI --> Screen: 500 Internal Sever Error
    Screen --> User: 以下のエラーメッセージをアラートで表示。
    note right User
      「テストケース結果登録に失敗しました。再度お試しください。」
    end note
  end
else トークン無し
  ResultAPI --> Screen: 401 Unauthorized
  Screen -> Screen: 保存された情報を削除
  Screen --> User: ログイン画面へリダイレクト。
else 権限チェック失敗
  ResultAPI --> Screen: 403 Forbidden
  Screen --> User: 権限エラーを表示。
else リクエストパラメータ不正
  ResultAPI --> Screen: 400 Bad Request
  Screen --> User: パラメータエラーを表示。
end

== S3ライフサイクルポリシーによる自動クリーンアップ ==
note over S3
  24時間後...
  
  S3ライフサイクルポリシーが自動実行
  temp/ フォルダ内のファイルを削除
end note

@enduml