@startuml テストケース新規登録_登録ボタン押下時
scale max 3000 height
title テストケース登録シーケンス図

actor "ログインユーザ" as User
participant "テストケース新規登録画面" as TestCaseRegist
participant "S3署名付きURL発行API" as S3API
participant "AWS S3" as S3
participant "テストケース新規登録API" as TestCaseRegistApi
participant "AWS RDS" as RDS

== ファイルアップロード ==
User -> TestCaseRegist: テストケース入力\n+ ファイル選択

loop 各ファイルについて
    TestCaseRegist -> S3API: S3署名付きURL発行APIをリクエスト
    note right of S3API
      temp/ フォルダに一時保存
      24時間後に自動削除
    end note
    S3API -> S3API: JWT検証 + 署名付きURL生成
    S3API --> TestCaseRegist: { presignedUrl, tempS3Key }

    TestCaseRegist -> S3: ファイルをアップロード
    S3 -> S3: temp/ にファイル保存
    note right of S3
      例: temp/1234567890-specification.pdf
    end note
    S3 --> TestCaseRegist: 200 OK
    
    TestCaseRegist -> TestCaseRegist: tempS3Keyを配列に追加
end

TestCaseRegist --> User: ファイルアップロード完了

== テストケース登録 + 本番フォルダへコピー ==
User -> TestCaseRegist: 「登録」ボタンクリック

TestCaseRegist -> TestCaseRegistApi: テストケース新規登録APIをリクエスト

note right TestCaseRegistApi
  Authorization: Bearer{JWT}
end note

ref over TestCaseRegistApi
  ミドルウェアで権限チェック(許可された権限[システム管理者、テスト管理者])
end ref

alt 権限あり
    TestCaseRegistApi -> RDS: 入力されたテストケース情報を登録
    note right of RDS
    INSERT INTO tt_test_cases
    (
      test_group_id,
      tid,
      first_layer,
      second_layer,
      third_layer,
      fourth_layer,
      purpose,
      request_id,
      check_items,
      test_procedure,
      created_at,
      updated_at,
      is_deleted
    )
    VALUES
    (
      入力されたtest_group_id,
      入力されたtid,
      入力されたfirst_layer,
      入力されたsecond_layer,
      入力されたthird_layer,
      入力されたfourth_layer,
      入力されたpurpose,
      入力されたrequest_id,
      入力されたcheck_items,
      入力されたtest_procedure,
      CURRENT_TIMESTAMP,
      CURRENT_TIMESTAMP,
      false
    )
    RETURNING id;
    end note
    RDS --> TestCaseRegistApi: テストケースIDを返却

    loop temp_filesの各tempS3Key
        TestCaseRegistApi -> S3: temp/ から本番ディレクトリにコピー
        S3 --> TestCaseRegistApi: コピー完了

        TestCaseRegistApi -> RDS: ファイル情報を登録
        note right of RDS
        INSERT INTO tt_test_case_files
        (
          test_group_id,
          tid,
          file_type,
          file_no,
          file_name,
          file_path,
          created_at,
          updated_at,
          is_deleted
        )
        VALUES
        (
          入力されたtest_group_id,
          入力されたtid,
          入力されたfile_type,
          入力されたfile_no,
          入力されたfile_name,
          本番S3パス,
          CURRENT_TIMESTAMP,
          CURRENT_TIMESTAMP,
          false
        );
        end note
    end

    loop 各テストケースについて
        TestCaseRegistApi -> RDS: テストケース内容を登録
        note right RDS
        INSERT INTO tt_test_contents
        (
          test_group_id,
          tid,
          test_case_no,
          test_case,
          expected_value,
          is_target,
          created_at,
          updated_at,
          is_deleted
        )
        VALUES
        (
          入力されたtest_group_id,
          入力されたtid,
          入力されたtest_case_no,
          入力されたtest_case,
          入力されたexpected_value,
          true,
          CURRENT_TIMESTAMP,
          CURRENT_TIMESTAMP,
          false
        );
        end note
    end

    alt 登録成功
        RDS --> TestCaseRegistApi: 登録件数を返却
        TestCaseRegistApi --> TestCaseRegist: 201 Created
        TestCaseRegist --> User: テストケース一覧へ遷移する
    else 登録失敗
        RDS --> TestCaseRegistApi: エラーを返却
        TestCaseRegistApi --> TestCaseRegist: 500 Internal Server Error
        TestCaseRegist --> User: 以下のエラーメッセージをアラートで表示
        note right User
          「テストケース登録に失敗しました。再度お試しください。」
        end note
    end
else 権限なし
    TestCaseRegistApi --> TestCaseRegist: 403 Forbidden
    TestCaseRegist --> User: 権限エラーを表示
end

== S3ライフサイクルポリシーによる自動クリーンアップ ==
note over S3
  24時間後...
  
  S3ライフサイクルポリシーが自動実行
  temp/ フォルダ内のファイルを削除
end note

@enduml