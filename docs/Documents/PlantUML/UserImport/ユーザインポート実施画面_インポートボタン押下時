@startuml
scale max 3000 height
title インポートボタン押下時シーケンス図

actor "ログインユーザ" as User
participant "ユーザインポート実施画面" as UserImportExecute
participant "ユーザインポートAPI" as UserImportExecuteApi
participant "AWS Batch" as Batch
participant "AWS RDS" as Rds

User -> UserImportExecute: インポートボタン押下
UserImportExecute -> UserImportExecute: ブラウザからJWTトークンを取得。

alt トークン無し
  UserImportExecute --> User: ログイン画面へリダイレクト。
else トークン記載のuser_roleが0(システム管理者)以外の場合
  UserImportExecute --> User: 権限エラーを表示。
end
UserImportExecute -> UserImportExecuteApi: ユーザインポートAPIをリクエスト。
note right UserImportExecuteApi
  Authorization: Bearer{JWT}
end note

ref over UserImportExecuteApi
  ミドルウェアで権限チェック(許可された権限:[システム管理者])
end ref

alt 権限チェック成功
  UserImportExecuteApi -> Batch: ユーザインポートバッチを実行。\n※バッチ仕様は別紙バッチ設計書を参照。
  UserImportExecuteApi -> Rds: インポート結果情報を登録。
  note right Rds
    INSERT INTO tt_import_result
    (
      file_name,
      import_date
      import_status,
      executor_name,
      import_type,
      count
    )
    VALUES
    (
      入力したファイル名,
      インポートした日付け,
      0(0:実施中、1:完了、2:エラー),
      ログインユーザ,
      0(0:ユーザ、1:テストケース),
      インポートファイルに記載されているユーザ情報の件数
    )
  end note

  alt 登録成功
    Rds --> UserImportExecuteApi: 登録件数を返却。
    UserImportExecuteApi -> UserImportExecute: 201 Created 
    UserImportExecute --> User: インポート結果一覧画面へ遷移する。
  else 登録失敗
    Rds --> UserImportExecuteApi: エラーを返却。
    UserImportExecuteApi --> UserImportExecute: 500 Internal Server Error
    UserImportExecute -> User: 以下のエラーメッセージをアラートで表示する。
    note right User
      ユーザインポートに失敗しました。再度お試しください。
    end note
  end
else トークン無し
  UserImportExecuteApi --> UserImportExecute: 401 Unauthorized
  UserImportExecute -> UserImportExecute: 保存された情報を削除。
  UserImportExecute --> User: ログイン画面へリダイレクト。
else 権限チェック失敗
  UserImportExecuteApi --> UserImportExecute: 403 Forbidden
  UserImportExecute --> User: 権限エラーを表示。
else リクエストパラメータ不正
  UserImportExecuteApi --> UserImportExecute: 400 Bad Request
  UserImportExecute --> User: パラメータエラーを表示。
end
@enduml
