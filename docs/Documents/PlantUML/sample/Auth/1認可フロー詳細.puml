@startuml 認証フロー詳細_Part1
autonumber
actor "ログインユーザー" as User
participant "画面\n(/login)" as Screen
participant "NextAuth.js\nClient" as NextAuthClient
participant "API\n(/api/auth/[...nextauth])" as AuthAPI
participant "CredentialsProvider" as Provider
participant "Database" as DB

User -> Screen: メールとパスワード入力
activate Screen
Screen -> NextAuthClient: signIn('credentials', { email, password })
activate NextAuthClient
NextAuthClient -> AuthAPI: POST /api/auth/callback/credentials
activate AuthAPI
AuthAPI -> Provider: authorize(credentials)
activate Provider
Provider -> Provider: 入力値検証
Provider -> DB: SELECT * FROM mt_users WHERE email = $1
activate DB
DB -> Provider: ユーザー情報
deactivate DB
alt ユーザーなし
    Provider -> AuthAPI: throw Error
    deactivate Provider
    AuthAPI -> NextAuthClient: 401 Unauthorized
    deactivate AuthAPI
    NextAuthClient -> Screen: 認証失敗
    deactivate NextAuthClient
    Screen -> User: エラー表示
else ユーザー存在
    Provider -> Provider: bcrypt.compare(password, hash)
    alt パスワード不一致
        Provider -> AuthAPI: throw Error
        AuthAPI -> Screen: エラー
    else パスワード一致
        Provider -> AuthAPI: return user
        note right: 次のPart2へ続く
    end
end
deactivate Screen
@enduml