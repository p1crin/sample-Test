@startuml テスト結果登録画面
autonumber
actor "ログインユーザー" as User
participant "画面\n(/test-groups/[groupId]/cases/[tid]/[testCaseNo]/results/new)" as Screen
participant "API\n(/api/test-groups/[groupId]/cases/[tid]/[testCaseNo]/results)" as API

User -> Screen: 画面アクセス
activate Screen
Screen -> API: GET /api/test-groups/[groupId]/cases/[tid]
activate API
API -> API: JWTトークン検証
API -> API: 実施者ロール確認\n(test_role = 2)
alt 実施者ロールあり
    API -> Screen: 200 OK
    deactivate API
    Screen -> User: フォーム表示
else ロールなし
    API -> Screen: 403 Forbidden
    deactivate API
    Screen -> User: エラー表示
end
deactivate Screen

User -> Screen: フォーム入力して送信\n(result, judgment, versions)
activate Screen
Screen -> API: POST /api/test-groups/[groupId]/cases/[tid]/[testCaseNo]/results\n{ result, judgment, versions }
activate API
API -> API: JWTトークン検証
API -> API: 実施者ロール確認
API -> API: BEGIN TRANSACTION
API -> API: SELECT history_count FROM tt_test_results\nWHERE test_content_id = $1
alt 初回登録
    API -> API: INSERT INTO tt_test_results\n(test_content_id, result, judgment, history_count=1)
else 更新
    API -> API: UPDATE tt_test_results\nSET result=$1, judgment=$2, history_count=history_count+1
end
API -> API: INSERT INTO tt_test_results_history\n(test_content_id, history_count, result, judgment)
API -> API: COMMIT
API -> Screen: 201 Created
deactivate API
Screen -> User: /test-groups/[groupId]/cases/[tid]/resultsにリダイレクト
deactivate Screen
@enduml