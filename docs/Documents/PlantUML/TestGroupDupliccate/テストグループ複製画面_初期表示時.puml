@startuml
scale max 3000 height
title 初期表示時シーケンス図

actor "ログインユーザ" as User
participant "テストグループ複製画面" as TestGroupDuplicate
participant "タグ一覧取得API" as TagsAPI
participant "テストグループ詳細取得API" as TestGroupInfoApi
participant "AWS RDS" as Rds

User -> TestGroupDuplicate: テストグループ複製画面へアクセス。
TestGroupDuplicate -> TestGroupDuplicate: ブラウザからJWTトークンを取得。

alt トークン無し
  TestGroupDuplicate --> User: ログイン画面へリダイレクト。
else トークン記載のuser_roleが0(システム管理者)、1(テスト管理者)以外の場合
  TestGroupDuplicate --> User: 権限エラーを表示。
end
TestGroupDuplicate -> TagsAPI: タグ一覧取得APIをリクエスト
note right TagsAPI
  Authorization: Bearer{JWT}
end note

ref over TagsAPI
  ミドルウェアで権限チェック(許可された権限[システム管理者、テスト管理者])
end ref

alt 権限チェック成功
  TagsAPI -> Rds: タグ情報を全件取得。
  note right of Rds
  SELECT id, name FROM mt_tags;
  end note
  alt 取得成功
    Rds --> TagsAPI: データを返却
    TagsAPI --> TestGroupDuplicate: 200 OK
  else 取得失敗
    Rds --> TagsAPI: エラーを返却
    TagsAPI --> TestGroupDuplicate: 500 Internal Server Error
    TestGroupDuplicate --> User: サーバーエラーを表示。
  end
else トークン無し
  TagsAPI --> TestGroupDuplicate: 401 Unauthorized
  TestGroupDuplicate -> TestGroupDuplicate: 保存された情報を削除
  TestGroupDuplicate --> User: ログイン画面へリダイレクト。
else 権限チェック失敗
  TagsAPI --> TestGroupDuplicate: 403 Forbidden
  TestGroupDuplicate --> User: 権限エラーを表示。
else リクエストパラメータ不正
  TagsAPI --> TestGroupDuplicate: 400 Bad Request
  TestGroupDuplicate --> User: パラメータエラーを表示。
end
TestGroupDuplicate --> TestGroupInfoApi: テストグループ詳細取得API\nをリクエスト。
note right TestGroupInfoApi
  Authorization: Bearer{JWT}
end note

ref over TestGroupInfoApi
  ミドルウェアで権限チェック(許可された権限[システム管理者、テスト管理者])
end ref

alt 権限チェック成功
  TestGroupInfoApi -> Rds: 該当するテストグループ情報を取得。
  note right Rds
    SELECT
      id,
      oem,
      model,
      event,
      variation,
      destination,
      specs,
      test_startdate,
      test_enddate,
      ng_plan_count,
      created_by,
      updated_by
    WHERE
      id = リクエストパラメータのテストグループID;
  end note

  TestGroupInfoApi --> Rds: テストグループタグ関連情報とタグ情報を取得。
  note right Rds
    SELECT
        mt_tags.id,
        mt_tags.name,
        tt_test_group_tags.test_role
    FROM mt_tags
    INNER JOIN
      tt_test_group_tags
    ON mt_tags.id = tt_test_group_tags.tag_id
    WHERE
      tt_test_group_tags.test_group_id = リクエストパラメータのテストグループID;
  end note

  alt 取得成功
    Rds --> TestGroupInfoApi: データを返却。
    TestGroupInfoApi --> TestGroupDuplicate: 200 OK
    TestGroupDuplicate --> User: テストケース複製画面を表示。
  else 取得失敗
    Rds --> TestGroupInfoApi: エラーを返却。
    TestGroupInfoApi --> TestGroupDuplicate: 500 Internal Server Error
    TestGroupDuplicate --> User: サーバーエラーを表示。
  end
else トークン無し
  TestGroupInfoApi --> TestGroupDuplicate: 401 Unauthorized
  TestGroupDuplicate -> TestGroupDuplicate: 保存された情報を削除
  TestGroupDuplicate --> User: ログイン画面へリダイレクト。
else 権限チェック失敗
  TestGroupInfoApi --> TestGroupDuplicate: 403 Forbidden
  TestGroupDuplicate --> User: 権限エラーを表示。
else リクエストパラメータ不正
  TestGroupInfoApi --> TestGroupDuplicate: 400 Bad Request
  TestGroupDuplicate --> User: パラメータエラーを表示。
end
TestGroupDuplicate --> User :テストグループ複製画面を表示する。
@enduml
