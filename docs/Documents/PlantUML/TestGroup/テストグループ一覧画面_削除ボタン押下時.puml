@startuml テストグループ一覧_削除ボタン押下時
scale max 3000 height
title 削除ボタン押下時シーケンス図

actor "ログインユーザ" as User
participant "テストグループ一覧画面" as Screen
participant "テストケース件数取得API" as CountApi
participant "テストグループ削除API" as DeleteApi
participant "AWS RDS" as RDS
participant "AWS S3" as S3

User -> Screen: 削除ボタン押下
activate Screen

Screen -> CountApi: GET /api/test-groups/{groupId}/case-count
activate CountApi
note right CountApi
  Authorization: Bearer{JWT}
  Path: {groupId}
end note

alt 権限チェック成功 (システム管理者 OR テスト管理者)
  CountApi -> RDS: テストケース件数を取得
  note right RDS
    SELECT COUNT(*) as count
    FROM tt_test_cases
    WHERE test_group_id = groupId
    AND is_deleted = FALSE;
  end note

  Rds --> CountApi: 件数を返却
  CountApi --> Screen: 200 OK\n{ success: true, data: { count: n } }
  deactivate CountApi

  Screen --> User: 削除確認モーダル表示\n(n件のテストケースが失われます)

  alt 削除ボタンを押下した場合 (再確認)
    User -> Screen: 削除ボタン押下
    Screen --> User: 再確認モーダル表示\n(本当に削除しますか？)

    alt 削除ボタンを押下した場合 (最終確認)
      User -> Screen: 削除ボタン押下
      Screen -> DeleteApi: DELETE /api/test-groups/{groupId}
      activate DeleteApi
      note right DeleteApi
        Authorization: Bearer{JWT}
        Path: {groupId}
      end note

      alt 権限チェック成功
        DeleteApi -> RDS: 削除対象のファイルパスを取得
        note right RDS
          SELECT tcf.file_path FROM tt_test_case_files tcf
          WHERE tcf.test_group_id = groupId
          AND NOT EXISTS(...);
        end note
        Rds --> DeleteApi: ファイルパス を返却

        DeleteApi -> RDS: 削除対象のエビデンスパスを取得
        note right RDS
          SELECT evidence_path FROM tt_test_evidences
          WHERE test_group_id = groupId;
        end note
        Rds --> DeleteApi: エビデンスパス を返却

        DeleteApi -> RDS: テストグループ配下の全テーブルから\nデータをカスケード削除
        note right RDS
          - tt_test_evidences
          - tt_test_results_history
          - tt_test_results
          - tt_test_contents
          - tt_test_case_files
          - tt_test_cases
          - tt_test_group_tags
          - tt_test_groups
        end note

        alt 削除成功
          Rds --> DeleteApi: 削除完了
          DeleteApi -> S3: S3 上の関連ファイルを削除
          S3 --> DeleteApi: 削除完了
          DeleteApi --> Screen: 200 OK\n{ success: true }
          deactivate DeleteApi

          Screen -> Screen: apiError = null\nstate更新\nページをリセット
          Screen --> User: テストグループ一覧を再表示

        else 削除失敗
          Rds --> DeleteApi: エラーを返却
          DeleteApi --> Screen: 500 Internal Server Error
          deactivate DeleteApi

          Screen -> Screen: apiError = "500 Internal Server Error"\nthrow apiError
          Screen --> User: 500 エラー画面表示
        end

      else 401 Unauthorized
        DeleteApi --> Screen: 401 Unauthorized
        deactivate DeleteApi
        Screen -> Screen: apiError = "401 Unauthorized"\nthrow apiError
        Screen --> User: 401 エラー画面表示

      else 403 Forbidden
        DeleteApi --> Screen: 403 Forbidden
        deactivate DeleteApi
        Screen -> Screen: apiError = "403 Forbidden"\nthrow apiError
        Screen --> User: 403 エラー画面表示

      else 400 Bad Request
        DeleteApi --> Screen: 400 Bad Request
        deactivate DeleteApi
        Screen -> Screen: apiError = "400 Bad Request"\nthrow apiError
        Screen --> User: 400 エラー画面表示
      end

    else キャンセルボタンを押下した場合
      User -> Screen: キャンセルボタン押下
      Screen -> Screen: 再確認モーダルを閉じる
    end

  else キャンセルボタンを押下した場合
    User -> Screen: キャンセルボタン押下
    Screen -> Screen: 削除確認モーダルを閉じる
  end

else 401 Unauthorized
  CountApi --> Screen: 401 Unauthorized
  deactivate CountApi
  Screen -> Screen: apiError = "401 Unauthorized"\nthrow apiError
  Screen --> User: 401 エラー画面表示

else 403 Forbidden
  CountApi --> Screen: 403 Forbidden
  deactivate CountApi
  Screen -> Screen: apiError = "403 Forbidden"\nthrow apiError
  Screen --> User: 403 エラー画面表示

else 500 Internal Server Error
  CountApi --> Screen: 500 Internal Server Error
  deactivate CountApi
  Screen -> Screen: apiError = "500 Internal Server Error"\nthrow apiError
  Screen --> User: 500 エラー画面表示
end

deactivate Screen
@enduml
