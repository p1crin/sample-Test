@startuml テストグループ一覧_初期表示時
scale max 3000 height
title 初期表示時シーケンス図
actor "ログインユーザ" as User
participant "テストグループ一覧画面" as Screen
participant "テストグループ一覧取得API" as TestGroupApi
participant "AWS RDS" as Rds

User -> Screen: テストグループ一覧画面へアクセス
activate Screen

Screen -> Screen: getServerSession()で認証確認
alt 未認証
    Screen --> User: Unauthorized エラー発生
else 認証済み
    Screen -> TestGroupApi: GET /api/test-groups?page=1&pageSize=10
    activate TestGroupApi
    note right TestGroupApi
      Authorization: Bearer{JWT}
      Query: page=1, pageSize=10
    end note

    ref over TestGroupApi
      JWTトークン検証 & ミドルウェアで権限チェック
      (許可された権限[システム管理者、テスト管理者、一般])
    end ref

    alt 権限チェック成功
      alt 取得したユーザの権限が0(システム管理者)
        TestGroupApi -> Rds: アクセス可能なテストグループのIDを取得
        note right Rds
          SELECT id FROM tt_test_groups
          WHERE is_deleted = FALSE;
        end note
        Rds --> TestGroupApi: 全ID を返却

      else 取得したユーザの権限が1(テスト管理者)
        TestGroupApi -> Rds: アクセス可能なテストグループのIDを取得
        note right Rds
          SELECT DISTINCT tg.id
          FROM tt_test_groups tg
          LEFT JOIN tt_test_group_tags tgt ON tg.id = tgt.test_group_id
          LEFT JOIN mt_user_tags ut ON tgt.tag_id = ut.tag_id
          WHERE tg.is_deleted = FALSE
          AND (tg.created_by = ユーザID OR ut.user_id = ユーザID);
        end note
        Rds --> TestGroupApi: アクセス可能なID を返却

      else 取得したユーザの権限が2(一般)
        TestGroupApi -> Rds: アクセス可能なテストグループのIDを取得
        note right Rds
          SELECT DISTINCT tgt.test_group_id
          FROM tt_test_group_tags tgt
          JOIN mt_user_tags ut ON tgt.tag_id = ut.tag_id
          WHERE ut.user_id = ユーザID;
        end note
        Rds --> TestGroupApi: アクセス可能なID を返却
      end

      TestGroupApi -> Rds: テストグループ情報を取得\n(ID = ANY + ページング)
      note right Rds
        SELECT id, oem, model, event, variation, destination, ...
        FROM tt_test_groups
        WHERE id = ANY(アクセス可能なID)
        AND is_deleted = FALSE
        ORDER BY created_at DESC
        LIMIT 10 OFFSET 0;
      end note

      Rds --> TestGroupApi: テストグループデータを返却
      TestGroupApi --> Screen: 200 OK\n{ success: true, data: [...], pageInfo: { page: 1, pageSize: 10, pageCount: n } }
      deactivate TestGroupApi

      Screen -> Screen: apiError = null\nstate更新\n(ページング情報含む)
      Screen --> User: テストグループ一覧表示

    else トークン無し
      TestGroupApi --> Screen: 401 Unauthorized
      deactivate TestGroupApi
      Screen -> Screen: apiError = "401 Unauthorized"\nthrow apiError
      Screen --> User: 401 エラー画面表示

    else 権限チェック失敗
      TestGroupApi --> Screen: 403 Forbidden
      deactivate TestGroupApi
      Screen -> Screen: apiError = "403 Forbidden"\nthrow apiError
      Screen --> User: 403 エラー画面表示

    else リクエストパラメータ不正
      TestGroupApi --> Screen: 400 Bad Request
      deactivate TestGroupApi
      Screen -> Screen: apiError = "400 Bad Request"\nthrow apiError
      Screen --> User: 400 エラー画面表示
    end
end

deactivate Screen
@enduml